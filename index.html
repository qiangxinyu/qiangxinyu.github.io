<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="一艘小船">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="一艘小船">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="qxy">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>一艘小船</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">一艘小船</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">说翻就翻</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/05/RN_6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/05/RN_6/" class="post-title-link" itemprop="url">React Native (六)：加载所有分类与详情页</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-05 16:12:00" itemprop="dateCreated datePublished" datetime="2017-05-05T16:12:00+08:00">2017-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:20:19" itemprop="dateModified" datetime="2023-12-21T21:20:19+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<h2 id="1-加载全部分类新闻"><a href="#1-加载全部分类新闻" class="headerlink" title="1.加载全部分类新闻"></a>1.加载全部分类新闻</h2><p>我们需要做的效果是打开 <code>App</code> ，首先只加载第一页的数据，其他页面在第一次显示的时候加载数据。</p>
<p>我们需要一个状态来标明是不是第一次显示，给 <code>state</code> 加入 <code>isFirstShow: true</code>，我们在网络请求里给他赋值为 <code>false</code>。</p>
<p>在做的过程中发现一个问题，我们需要取到它的 <code>EndKey</code> 来作为下次请求的 <code>StartKey</code> ，否则可能会请求失败，给 <code>state</code> 加入 <code>startKey: &#39;&#39;</code> ，然后在请求到数据后赋值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title function_">_onRefresh</span>(<span class="params">page</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isFirstShow</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_begainRefresh</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (page == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                page</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">            page = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newspush/list/index.html?clientid=1114283782&amp;v=1.1&amp;type=&#x27;</span></span><br><span class="line">            + <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>.<span class="property">NameEN</span></span><br><span class="line">            + <span class="string">&#x27;&amp;startkey=&#x27;</span></span><br><span class="line">            + <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">startKey</span></span><br><span class="line">            +<span class="string">&#x27;&amp;newkey=&amp;index=&#x27;</span></span><br><span class="line">            + page</span><br><span class="line">            + <span class="string">&#x27;&amp;size=&#x27;</span></span><br><span class="line">            + maxCount</span><br><span class="line">            + <span class="string">&#x27;&amp;ime=6271F554-7B2F-45DE-887E-4A336F64DEE6&amp;apptypeid=ZJZYIOS1114283782&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">LOG</span>(<span class="string">&#x27;url=》&#x27;</span>, url)</span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_endRefresh</span>()</span><br><span class="line"></span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> list = json.<span class="property">NewsList</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> swipers = []</span><br><span class="line">                        <span class="keyword">let</span> news = []</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (page == <span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">                                <span class="keyword">let</span> dic = list[index]</span><br><span class="line">                                index &lt; <span class="number">4</span> ? swipers.<span class="title function_">push</span>(dic) : news.<span class="title function_">push</span>(dic)</span><br><span class="line">                            &#125;</span><br><span class="line">                            news.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">0</span>, swipers)</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            news = list</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> newData = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">data</span>.<span class="title function_">concat</span>(news)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> hasMore = list.<span class="property">length</span> == maxCount ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                            <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(newData),</span><br><span class="line">                            <span class="attr">data</span>: newData,</span><br><span class="line">                            <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span> + (hasMore ? <span class="number">1</span> : <span class="number">0</span>),</span><br><span class="line">                            <span class="attr">showFooter</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span> ? <span class="literal">true</span> : (hasMore ? <span class="literal">true</span> : <span class="literal">false</span>),</span><br><span class="line">                            hasMore,</span><br><span class="line">                            <span class="attr">startKey</span>: json.<span class="property">EndKey</span> ? json.<span class="property">EndKey</span> : <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">startKey</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR then =&gt;&#x27;</span>, url, e)</span><br><span class="line"></span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_endRefresh</span>()</span><br><span class="line">                <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR=&gt;&#x27;</span>, url, <span class="string">&#x27;==&gt;&#x27;</span>, error)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后返回我们的 <code>Home.js</code> ，在这里处理是否请求数据：</p>
<p>首先给 <code>NewsList</code> 加上 <code>ref</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">lists.<span class="title function_">push</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">NewsList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">ref</span>=<span class="string">&#123;</span>&#x27;<span class="attr">NewsList</span>&#x27; + <span class="attr">index</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;, <span class="attr">width:</span> <span class="attr">width</span>, <span class="attr">height:</span> <span class="attr">height</span> <span class="attr">-</span> <span class="attr">64</span> <span class="attr">-</span> <span class="attr">49</span> <span class="attr">-</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">isRequest</span>=<span class="string">&#123;index</span> == <span class="string">0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">touchIn</span>=<span class="string">&#123;(scrollEnabled)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">            this.refs.ScrollView.setNativeProps(&#123;scrollEnabled: !scrollEnabled&#125;)</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">    /&gt;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>然后在点击 <code>SegmentedView</code> 和滑动 <code>ScrollView</code> 的时候来进行处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">SegmentedView</span></span><br><span class="line">    ref=<span class="string">&quot;SegmentedView&quot;</span></span><br><span class="line">    list=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>&#125;</span><br><span class="line">    style=&#123;&#123;<span class="attr">height</span>: <span class="number">30</span>&#125;&#125;</span><br><span class="line">    selectItem=&#123;<span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">x</span>: width * index, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">animated</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_scrollTo</span>(index)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">ScrollView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">removeClippedSubviews</span>=<span class="string">&#123;Platform.OS</span> === <span class="string">&#x27;ios&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">ref</span>=<span class="string">&quot;ScrollView&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">horizontal</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">showsHorizontalScrollIndicator</span>=<span class="string">&#123;false&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">pagingEnabled</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">onMomentumScrollEnd</span>=<span class="string">&#123;(s)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">        let index = s.nativeEvent.contentOffset.x / width</span></span><br><span class="line"><span class="language-xml">        this.refs.SegmentedView._moveTo(index)</span></span><br><span class="line"><span class="language-xml">        this._scrollTo(index)</span></span><br><span class="line"><span class="language-xml">    &#125;&#125;</span></span><br><span class="line"><span class="language-xml">&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果是第一次显示，那么请求数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_scrollTo</span>(<span class="params">index</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> newsList = <span class="variable language_">this</span>.<span class="property">refs</span>[<span class="string">&#x27;NewsList&#x27;</span> + index]</span><br><span class="line">    newsList.<span class="property">state</span>.<span class="property">isFirstShow</span> &amp;&amp; newsList.<span class="title function_">_onRefresh</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="2-详情页"><a href="#2-详情页" class="headerlink" title="2.详情页"></a>2.详情页</h2><p>详情页进去是一个网页，我们直接写死一个网页。</p>
<p>创建 <code>NewsDetail.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">WebView</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NavigationBar</span> <span class="keyword">from</span> <span class="string">&#x27;../Custom/NavBarCommon&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">NewsDetail</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;详情页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">navigator</span>=<span class="string">&#123;this.props.navigator&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">WebView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;flex:1&#125;&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">source</span>=<span class="string">&#123;&#123;uri:</span> &#x27;<span class="attr">http:</span>//<span class="attr">zjzywap.eastday.com</span>/<span class="attr">m</span>/<span class="attr">170425001829725.html</span>?<span class="attr">fr</span>=<span class="string">toutiao&amp;qid</span>=<span class="string">zjxw&amp;apptypeid</span>=<span class="string">ZJZYIOS1114283782&amp;ime</span>=<span class="string">6271F554-7B2F-45DE-887E-4A336F64DEE6</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<p>然后我们去 <code>NewsList.js</code> 引入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">NewsDetail</span> <span class="keyword">from</span> <span class="string">&#x27;./NewsDetail&#x27;</span></span><br></pre></td></tr></table></figure>


<p>然后我们需要进行 <code>push</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_onPress</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">navigator</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">navigator</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">NewsDetail</span>,</span><br><span class="line">        <span class="attr">params</span>: &#123;</span><br><span class="line">            <span class="attr">navigator</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">navigator</span>, <span class="comment">//这个并不用传入, 这里只是为了演示参数的传入</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们 <code>push</code> 需要用到 <code>navigator</code>， 但是的 <code>NewsList</code> 我们并没有给它传入 <code>navigator</code> ，我们需要去 <code>Home.js</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">NewsList</span></span><br><span class="line">    ref=&#123;<span class="string">&#x27;NewsList&#x27;</span> + index&#125;</span><br><span class="line">    key=&#123;index&#125;</span><br><span class="line">    style=&#123;&#123;<span class="attr">backgroundColor</span>:<span class="string">&#x27;white&#x27;</span>, <span class="attr">width</span>: width, <span class="attr">height</span>: height - <span class="number">64</span> - <span class="number">49</span> - <span class="number">30</span>&#125;&#125;</span><br><span class="line">    dic=&#123;dic&#125;</span><br><span class="line">    isRequest=&#123;index == <span class="number">0</span>&#125;</span><br><span class="line">    touchIn=&#123;<span class="function">(<span class="params">scrollEnabled</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">setNativeProps</span>(&#123;<span class="attr">scrollEnabled</span>: !scrollEnabled&#125;)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">    navigator=&#123;<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">navigator</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>然后进行调用</p>
<p>在 <code>renderRow</code> 方法内的 <code>CarousePicture</code> 以及下面的 2 个 <code>TouchableOpacity</code> 加入属性 <code>onPress=&#123;this._onPress&#125;</code></p>
<p>例如这样:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">CarousePicture</span></span><br><span class="line">    index=&#123;<span class="number">5</span>&#125;</span><br><span class="line">    ref=<span class="string">&quot;ScrollView&quot;</span></span><br><span class="line">    rowData=&#123;rowData&#125;</span><br><span class="line">    style=&#123;&#123;width, <span class="attr">height</span>: <span class="number">200</span>&#125;&#125;</span><br><span class="line">    touchIn=&#123;<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">touchIn</span>&#125;</span><br><span class="line">    onPress=&#123;<span class="variable language_">this</span>.<span class="property">_onPress</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>最后我们需要进入 <code>CarousePicture.js</code> 内的 <code>TouchableWithoutFeedback</code> 来调用回调函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> &lt;<span class="title class_">TouchableWithoutFeedback</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">flex</span>:<span class="number">1</span>,width, <span class="attr">height</span>:<span class="number">200</span>, <span class="attr">backgroundColor</span>:<span class="string">&#x27;white&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">onPress</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onPress</span>()</span><br><span class="line">    &#125;&#125;</span><br><span class="line">    onPressIn=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">touchIn</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">touchIn</span>(<span class="literal">true</span>)</span><br><span class="line">    &#125;&#125;</span><br><span class="line"></span><br><span class="line">    onPressOut=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">touchIn</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">touchIn</span>(<span class="literal">false</span>)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>现在就可以 <code>push</code> 到详情页了</p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative6">项目地址</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/03/RN_5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/03/RN_5/" class="post-title-link" itemprop="url">React Native (五)：上下拉刷新加载</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-03 11:23:00" itemprop="dateCreated datePublished" datetime="2017-05-03T11:23:00+08:00">2017-05-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:19:47" itemprop="dateModified" datetime="2023-12-21T21:19:47+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<h2 id="1-下拉刷新"><a href="#1-下拉刷新" class="headerlink" title="1.下拉刷新"></a>1.下拉刷新</h2><p>下拉刷新我们使用 <code>React Native</code> 提供的组件 <code>RefreshControl</code>，去 <code>NewsList.js</code> 的 <code>ListView</code> 添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ListView</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">flex</span>:<span class="number">1</span>, <span class="attr">backgroundColor</span>:<span class="string">&#x27;white&#x27;</span>&#125;&#125;</span><br><span class="line">    dataSource=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>&#125; <span class="comment">//设置数据源</span></span><br><span class="line">    renderRow=&#123;<span class="variable language_">this</span>.<span class="property">renderRow</span>&#125; <span class="comment">//设置cell</span></span><br><span class="line">    removeClippedSubviews=&#123;<span class="literal">false</span>&#125;</span><br><span class="line">    refreshControl=&#123;</span><br><span class="line">          <span class="language-xml"><span class="tag">&lt;<span class="name">RefreshControl</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">refreshing</span>=<span class="string">&#123;this.state.isRefreshing&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onRefresh</span>=<span class="string">&#123;()</span> =&gt;</span> this._onRefresh(1)&#125;</span></span><br><span class="line"><span class="language-xml">            tintColor=&quot;#999999&quot;</span></span><br><span class="line"><span class="language-xml">            title=&quot;加载中...&quot;</span></span><br><span class="line"><span class="language-xml">            titleColor=&quot;#999999&quot;</span></span><br><span class="line"><span class="language-xml">            colors=&#123;[&#x27;#ff0000&#x27;, &#x27;#00ff00&#x27;, &#x27;#0000ff&#x27;]&#125;</span></span><br><span class="line"><span class="language-xml">            progressBackgroundColor=&quot;#ffff00&quot;</span></span><br><span class="line"><span class="language-xml">          /&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p><code>ListView</code> 新加了一个属性 <code>removeClippedSubviews</code>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/issues/1831">原因</a></p>
<p>我们需要给 <code>state</code> 添加一个 <code>key</code> ： <code>isRefreshing: false</code> ，然后在网络请求时对它进行处理，（我这里省略了一些代码，要不然太长）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_begainRefresh</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isRefreshing</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">_endRefresh</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isRefreshing</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">_onRefresh</span>(<span class="params">page</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_begainRefresh</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (page == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                page</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_endRefresh</span>()</span><br><span class="line"></span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span> &#123;</span><br><span class="line">                    ..... 数据的处理</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_endRefresh</span>()</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在运行程序就可以尽情地下拉刷新了。</p>
<h2 id="2-上拉加载"><a href="#2-上拉加载" class="headerlink" title="2.上拉加载"></a>2.上拉加载</h2><p>上拉加载我们利用 <code>ListView</code> 的 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/listview.html#onendreached">onEndReached</a> 方法来进行加载新数据，使用 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/listview.html#renderfooter">renderFooter</a> 来进行显示状态。</p>
<p>这样严格的来说并不算上拉加载，只是滑动到底部自动进行加载。</p>
<p>首先在 <code>ListView</code> 加入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onEndReached=&#123; <span class="variable language_">this</span>.<span class="property">_toEnd</span> &#125;</span><br><span class="line">onEndReachedThreshold=&#123;<span class="number">10</span>&#125;</span><br><span class="line">renderFooter=&#123; <span class="variable language_">this</span>.<span class="property">_renderFooter</span> &#125;</span><br></pre></td></tr></table></figure>

<p>记得进行绑定</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_toEnd</span> = <span class="variable language_">this</span>.<span class="property">_toEnd</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_renderFooter</span> = <span class="variable language_">this</span>.<span class="property">_renderFooter</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_toEnd</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isRefreshing</span>) <span class="keyword">return</span>  </span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_onRefresh</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">_renderFooter</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:</span> <span class="attr">40</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">FFFFFF</span>&#x27;, <span class="attr">alignItems:</span>&#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span>&gt;</span>正在加载更多...<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们需要对数据进行处理，保存请求到的数据，再下一页数据请求到后加入数组，我们给 <code>state</code> 加入一个 <code>data: []</code>，然后对请求到的数据进行处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> list = json.<span class="property">NewsList</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> swipers = []</span><br><span class="line"><span class="keyword">let</span> news = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (page == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">        <span class="keyword">let</span> dic = list[index]</span><br><span class="line">        index &lt; <span class="number">4</span> ? swipers.<span class="title function_">push</span>(dic) : news.<span class="title function_">push</span>(dic)</span><br><span class="line">    &#125;</span><br><span class="line">    news.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">0</span>, swipers)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    news = list</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> newData = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">data</span>.<span class="title function_">concat</span>(news)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(newData),</span><br><span class="line">    <span class="attr">data</span>: newData,</span><br><span class="line">    <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span> + (list.<span class="property">length</span> == maxCount ? <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的 <code>maxCount</code> 是为了方便管理的，定义为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> maxCount = <span class="number">20</span></span><br></pre></td></tr></table></figure>

<p>请求的 <code>url</code> 改为 :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newspush/list/index.html?clientid=1114283782&amp;v=1.1&amp;type=&#x27;</span></span><br><span class="line">        + <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>.<span class="property">NameEN</span></span><br><span class="line">        + <span class="string">&#x27;&amp;startkey=3001_9223370543834829200_537d522d125e32ae&amp;newkey=&amp;index=&#x27;</span></span><br><span class="line">        + page</span><br><span class="line">        + <span class="string">&#x27;&amp;size=&#x27;</span></span><br><span class="line">        + maxCount</span><br><span class="line">        + <span class="string">&#x27;&amp;ime=6271F554-7B2F-45DE-887E-4A336F64DEE6&amp;apptypeid=ZJZYIOS1114283782&#x27;</span></span><br></pre></td></tr></table></figure>

<p>现在可以运行看看效果了。</p>
<p>我们会发现一开始在加载第一页数据的时候 <code>Footer</code> 也显示了出来，我们需要控制它的显示与隐藏，给 <code>state</code> 加入 <code>showFooter: false</code> ，在第一页数据加载完成并且返回的数组元素个数等于 <code>maxCount</code> 则赋值为 <code>true</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(newData),</span><br><span class="line">    <span class="attr">data</span>: newData,</span><br><span class="line">    <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span> + (list.<span class="property">length</span> == maxCount ? <span class="number">1</span> : <span class="number">0</span>),</span><br><span class="line">    <span class="attr">showFooter</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span> ? <span class="literal">true</span> :  (list.<span class="property">length</span> == maxCount ? <span class="literal">true</span> : <span class="literal">false</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_renderFooter</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:</span> <span class="attr">40</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">FFFFFF</span>&#x27;, <span class="attr">alignItems:</span>&#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span>&gt;</span>正在加载更多<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在 <code>Footer</code> 可以正确的显示隐藏了，但是我们还需要状态来改变 <code>Footer</code> 显示的文字，如果还有更多数据，那我们看见 <code>Footer</code> 的时候它的状态显然是正在加载更多，如果没有更多数据了，那我们就显示 已加载全部 。</p>
<p>给 <code>state</code> 加入 <code>hasMore: true</code> ，我们先假设它还有更多</p>
<p>然后在请求到数据进行处理:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hasMore = list.<span class="property">length</span> == maxCount ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(newData),</span><br><span class="line">    <span class="attr">data</span>: newData,</span><br><span class="line">    <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span> + (hasMore ? <span class="number">1</span> : <span class="number">0</span>),</span><br><span class="line">    <span class="attr">showFooter</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span> ? <span class="literal">true</span> :  (hasMore ? <span class="literal">true</span> : <span class="literal">false</span>),</span><br><span class="line">    hasMore,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然后处理 <code>renderFooter</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_renderFooter</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:</span> <span class="attr">40</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">FFFFFF</span>&#x27;, <span class="attr">alignItems:</span>&#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span>&gt;</span>&#123;this.state.hasMore ? &#x27;正在加载更多...&#x27; : &#x27;已加载全部&#x27;&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还需要再 <code>toEnd</code> 的判断条件加入 <code>hasMore</code> 来避免显示没有更多数据的时候拉倒底部还会进行请求数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_toEnd</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isRefreshing</span> || !<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">hasMore</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_onRefresh</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到现在上下拉刷新已经完成</p>
<p>这个上拉刷新比较简陋，你也可以放 <code>gif图</code> 或者使用 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/animations.html#content">动画</a> 来让界面变好看点。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative5">项目地址</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/24/RN_4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/24/RN_4/" class="post-title-link" itemprop="url">React Native (四)：加载新闻列表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-24 12:08:00" itemprop="dateCreated datePublished" datetime="2017-04-24T12:08:00+08:00">2017-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:19:20" itemprop="dateModified" datetime="2023-12-21T21:19:20+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<h2 id="1-标签与内容页联动"><a href="#1-标签与内容页联动" class="headerlink" title="1.标签与内容页联动"></a>1.标签与内容页联动</h2><p>上一节做到了点击标签自动移动，还差跟下面的视图进行联动。</p>
<p>首先创建 <code>NewsList.js</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">ListView</span>,</span><br><span class="line">    <span class="title class_">Image</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Dimensions</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"><span class="keyword">const</span> &#123;width, height&#125; = <span class="title class_">Dimensions</span>.<span class="title function_">get</span>(<span class="string">&#x27;window&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">NewsList</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;style&#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.view,style]&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>:<span class="string">&#x27;red&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>然后在 <code>Home.js</code> 引入，再加入 <code>ScrollView</code> ，现在 <code>Home.js</code> 的 <code>redner()</code> 是这样子的，这里加入的 <code>ScrollView</code> 我们在后文中称为 <code>NewsScrollView</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;首页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">unLeftImage</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SegmentedView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">ref</span>=<span class="string">&quot;SegmentedView&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">list</span>=<span class="string">&#123;this.state.list&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ScrollView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">ref</span>=<span class="string">&quot;ScrollView&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">horizontal</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">showsHorizontalScrollIndicator</span>=<span class="string">&#123;false&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">pagingEnabled</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    &#123; this._getNewsLists()&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>_getNewsLists()</code> 方法： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_getNewsLists</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> lists = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>[index]</span><br><span class="line">            lists.<span class="title function_">push</span>(</span><br><span class="line">                <span class="language-xml"><span class="tag">&lt;<span class="name">NewsList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span>&#x27;#&#x27; + <span class="attr">this._getColor</span>(&#x27;&#x27;,<span class="attr">0</span>), <span class="attr">width:</span> <span class="attr">width</span>, <span class="attr">height:</span> <span class="attr">height</span> <span class="attr">-</span> <span class="attr">49</span> <span class="attr">-</span> <span class="attr">64</span> <span class="attr">-</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lists</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">_getColor</span>(<span class="params">color, index</span>) &#123;</span><br><span class="line"></span><br><span class="line">    index ++</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == <span class="number">7</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> color</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    color = color + <span class="string">&#x27;0123456789abcdef&#x27;</span>[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">16</span>)]</span><br><span class="line">    <span class="keyword">return</span>  <span class="variable language_">this</span>.<span class="title function_">_getColor</span>(color, index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>根据返回的数据创建对应数量的视图，给随机颜色方便看效果。</p>
<p>先设置滑动 <code>NewsScrollView </code> 让标签跟着移动。</p>
<p>我们把 <code>SegmentedView</code> 中 <code>items.push</code> 中的 <code>onPress</code> 方法的实现单独写到一个方法里，然后在这里调用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_moveTo</span>(<span class="params">index</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; list &#125; = <span class="variable language_">this</span>.<span class="property">props</span>  <span class="comment">//获取到 传入的数组</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (list.<span class="property">length</span> &gt; maxItem) &#123;</span><br><span class="line">        <span class="keyword">let</span> meiosis = <span class="built_in">parseInt</span>(maxItem / <span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">x</span>: (index - meiosis &lt; <span class="number">0</span> ? <span class="number">0</span> : index - meiosis &gt; list.<span class="property">length</span> - maxItem ? list.<span class="property">length</span> - maxItem : index - meiosis ) * <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">itemWidth</span>, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">animated</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会发现我们给 <code>this.state</code> 加了一个 <code>itemWidth</code> ，原来我们获取 <code>itemWidth</code> 是在 <code>_getItems()</code> 中计算的，但是在渲染的过程中无法调用 <code>setState()</code> ，我们把计算 <code>itemWidth</code> 的方法移动到 :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentWillReceiveProps</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; list &#125; = props  <span class="comment">//获取到 传入的数组</span></span><br><span class="line">    <span class="keyword">if</span> (!list || list.<span class="property">length</span> == <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算每个标签的宽度</span></span><br><span class="line">    <span class="keyword">let</span> itemWidth = width / list.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (list.<span class="property">length</span> &gt; maxItem) &#123;</span><br><span class="line">        itemWidth = width / maxItem</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        itemWidth</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p><code>componentWillReceiveProps(props)</code> 方法会在属性更新后调用，参数 <code>props</code> 是新的属性。</p>
<p>现在运行会发现点击标签可以正常改变标签的状态，然而拖动 <code>NewsScrollView </code> 只会让上一个选中的变为未选中，新的标签并没有变为选中，这是因为选中状态只在标签被点击的时候进行了设置，我们需要给 <code>Item</code> 添加一个选中的方法 ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title function_">_select</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isSelect</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>_moveTo(index)</code> 进行调用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_select</span>()</span><br></pre></td></tr></table></figure>

<p>现在运行滑动 <code>NewsScrollView </code> 上面的 <code>SegmentedView</code> 可以正常运行了。</p>
<p>最后设置点击标签可以让 <code>NewsScrollView</code> 滑动到对应的位置，我们需要给 <code>SegmentedView</code> 加入一个回调函数，在标签被点击的时候调用返回点击的 <code>index</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">SegmentedView</span></span><br><span class="line">    ref=<span class="string">&quot;SegmentedView&quot;</span></span><br><span class="line">    list=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>&#125;</span><br><span class="line">    style=&#123;&#123;<span class="attr">height</span>: <span class="number">30</span>&#125;&#125;</span><br><span class="line">    selectItem=&#123;<span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">x</span>: width * index, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">animated</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>在 <code>SegmentedView </code> 进行调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_getItems</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; list, selectItem &#125; = <span class="variable language_">this</span>.<span class="property">props</span>  <span class="comment">//获取到 传入的数组</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!list || list.<span class="property">length</span> == <span class="number">0</span>) <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> items = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">        <span class="keyword">let</span> dic = list[index]</span><br><span class="line">        items.<span class="title function_">push</span>(</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">Item</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">ref</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">isSelect</span>=<span class="string">&#123;index</span> == <span class="string">0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">itemHeight</span>=<span class="string">&#123;this.state.itemHeight&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">itemWidth</span>=<span class="string">&#123;this.state.itemWidth&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onPress</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    this._moveTo(index)</span></span><br><span class="line"><span class="language-xml">                    selectItem &amp;&amp; selectItem(index)</span></span><br><span class="line"><span class="language-xml">                &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            /&gt;</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> items</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-加载新闻列表第一页数据"><a href="#2-加载新闻列表第一页数据" class="headerlink" title="2.加载新闻列表第一页数据"></a>2.加载新闻列表第一页数据</h2><p>在 <code>Home.js</code> 中已经给 <code>NewsList</code> 传入了数据，我们再给传入一个参数识别是否是第一页，初始只加载第一页的数据，也方便调试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_getNewsLists</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> lists = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>[index]</span><br><span class="line">            lists.<span class="title function_">push</span>(</span><br><span class="line">                <span class="language-xml"><span class="tag">&lt;<span class="name">NewsList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">isRequest</span>=<span class="string">&#123;index</span> == <span class="string">0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lists</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后去 <code>NewsList.js</code> 进行请求数据:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="comment">// 构造</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="comment">// 初始状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">        <span class="attr">page</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">rn</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">isRequest</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_onRefresh</span>()</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"> <span class="title function_">_onRefresh</span>(<span class="params">page</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newspush/list/index.html?clientid=1114283782&amp;v=1.1&amp;type=&#x27;</span></span><br><span class="line">            + <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>.<span class="property">NameEN</span></span><br><span class="line">            + <span class="string">&#x27;&amp;startkey=&amp;newkey=&amp;index=&#x27;</span></span><br><span class="line">            + (page ? page : <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span>)</span><br><span class="line">            + <span class="string">&#x27;&amp;size=20&amp;ime=6271F554-7B2F-45DE-887E-4A336F64DEE6&amp;apptypeid=ZJZYIOS1114283782&amp;rn=&#x27;</span></span><br><span class="line">            + <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">rn</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">LOG</span>(<span class="string">&#x27;url=》&#x27;</span>, url)</span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET SUCCESSED then =&gt;&#x27;</span>, url, json)</span><br><span class="line"></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR then =&gt;&#x27;</span>, url, e)</span><br><span class="line"></span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR=&gt;&#x27;</span>, url, <span class="string">&#x27;==&gt;&#x27;</span>, error)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求到数据后我们需要用 <code>ListView</code> (<a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/listview.html#content">官方文档</a>) 来显示， 所以导入 <code>ListView</code> ，然后去 <code>render()</code> 加入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;style&#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.view,style]&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">ListView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">style</span>=<span class="string">&#123;&#123;flex:1&#125;&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">dataSource</span>=<span class="string">&#123;this.state.dataSource&#125;</span> //<span class="attr">设置数据源</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">renderRow</span>=<span class="string">&#123;this.renderRow&#125;</span> //<span class="attr">设置cell</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后加入 <code>dataSource</code> 和 <code>renderRow</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title function_">getRowData</span> = (<span class="params">dataBlob, sectionID, rowID</span>) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dataBlob[sectionID][rowID]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 初始状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attr">page</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">rn</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">dataSource</span>: <span class="keyword">new</span> <span class="title class_">ListView</span>.<span class="title class_">DataSource</span>(&#123;</span><br><span class="line">            <span class="attr">getRowData</span>: getRowData,</span><br><span class="line">            <span class="attr">rowHasChanged</span>: <span class="function">(<span class="params">r1, r2</span>) =&gt;</span> r1 !== r2,</span><br><span class="line">        &#125;),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">renderRow</span> = <span class="variable language_">this</span>.<span class="property">renderRow</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="title function_">renderRow</span>(<span class="params">rowData, rowID, highlightRow</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> (</span><br><span class="line">		<span class="language-xml"><span class="tag">&lt;<span class="name">View</span> /&gt;</span></span></span><br><span class="line">	)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们要做的界面是这个样子</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative4/news_list.png?raw=true"></p>
<p>从上图可以看出来新闻分为 3 种样式，轮播图、有一张图片的和二、三张图片的。</p>
<p>接下来开始解析数据，解析完 <code>json</code> 数据发现只有一个数组，轮播图是取了前四个，剩下的根据 <code>ImagesList</code> 里图片的个数来判断，</p>
<p>去 <code>.then((json) =&gt; &#123;</code> 加入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> list = json.<span class="property">NewsList</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> swipers = []</span><br><span class="line"><span class="keyword">let</span> news = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">    <span class="keyword">let</span> dic = list[index]</span><br><span class="line">    index &lt; <span class="number">4</span> ? swipers.<span class="title function_">push</span>(dic) : news.<span class="title function_">push</span>(dic)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">news.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">0</span>, swipers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(news)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在 <code>news</code> 的数据结构为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	[</span><br><span class="line">		&#123;&#125;,</span><br><span class="line">		&#123;&#125;</span><br><span class="line">	],</span><br><span class="line">	</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">	&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后去 <code>renderRow</code> 处理数据</p>
<p>如果是数组，那么返回轮播图：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(rowData) === <span class="string">&#x27;[object Array]&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">CarousePicture</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">index</span>=<span class="string">&#123;2&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">ref</span>=<span class="string">&quot;ScrollView&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">rowData</span>=<span class="string">&#123;rowData&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:</span> <span class="attr">200</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">touchIn</span>=<span class="string">&#123;this.props.touchIn&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">CarousePicture</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的轮播图本来用的 <a target="_blank" rel="noopener" href="https://github.com/leecade/react-native-swiper"><code>Swiper</code></a>，但是在 <code>Android</code> 上有很多 BUG，我只好自己写了一个，但是在 <code>Android</code> 上的体验差强人意，源码在<a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative4/App/Home/CarousePicture.js">这里</a>，把文件导入项目即可。</p>
<p>具体的可以看<a target="_blank" rel="noopener" href="http://jiasm.org/2017/02/18/React-native%E8%B8%A9%E5%9D%91%E5%B0%8F%E8%AE%B0/">这里</a></p>
<p><code>touchIn</code> 是由于在 <code>Andoird</code> 上两个 <code>ScrollView</code> 重叠时，处于顶部的 <code>ScrollView</code> 滑动事件不会响应，因为底部的 <code>ScrollView</code> 进行了响应并拦截了事件，我们需要在手指接触到轮播图的时候禁用底部 <code>ScrollView</code> 的滑动属性，再手指离开的时候再进行恢复，所以还需要去 <code>Home.js</code> 加入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title function_">_getNewsLists</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> lists = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>[index]</span><br><span class="line">            lists.<span class="title function_">push</span>(</span><br><span class="line">                <span class="language-xml"><span class="tag">&lt;<span class="name">NewsList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;, <span class="attr">width:</span> <span class="attr">width</span>, <span class="attr">height:</span> <span class="attr">height</span> <span class="attr">-</span> <span class="attr">64</span> <span class="attr">-</span> <span class="attr">49</span> <span class="attr">-</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">isRequest</span>=<span class="string">&#123;index</span> == <span class="string">0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">touchIn</span>=<span class="string">&#123;(scrollEnabled)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                        this.refs.ScrollView.setNativeProps(&#123;scrollEnabled: !scrollEnabled&#125;)</span></span><br><span class="line"><span class="language-xml">                    &#125;&#125;</span></span><br><span class="line"><span class="language-xml">                /&gt;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> lists</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>然后根据 <code>ImagesList</code> 的个数来区分：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> imagesList = rowData.<span class="property">ImagesList</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (imagesList &amp;&amp; imagesList.<span class="property">length</span> == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">TouchableOpacity</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span>  <span class="attr">backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">View</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;, <span class="attr">flexDirection:</span>&#x27;<span class="attr">row</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">space-between</span>&#x27;, <span class="attr">flex:1</span>&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Image</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">resizeMode</span>=<span class="string">&quot;cover&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;marginTop:</span> <span class="attr">10</span>, <span class="attr">marginBottom:10</span>, <span class="attr">marginLeft:</span> <span class="attr">10</span>, <span class="attr">width:</span> <span class="attr">80</span>, <span class="attr">height:</span> <span class="attr">80</span>, <span class="attr">backgroundColor:</span>&#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">source</span>=<span class="string">&#123;&#123;uri:imagesList[0].ImgPath&#125;&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">View</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginRight:</span> <span class="attr">10</span>,<span class="attr">backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;, <span class="attr">marginTop:</span> <span class="attr">10</span>, <span class="attr">height:</span> <span class="attr">80</span>, <span class="attr">width:</span> <span class="attr">width</span> <span class="attr">-</span> <span class="attr">110</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Text</span>&gt;</span>&#123;rowData.Title&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;flex:1,</span> <span class="attr">flexDirection:</span> &#x27;<span class="attr">row</span>&#x27;, <span class="attr">justifyContent:</span> &#x27;<span class="attr">space-between</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginTop:10,</span> <span class="attr">fontSize:</span> <span class="attr">13</span>, <span class="attr">color:</span> &#x27;#<span class="attr">999999</span>&#x27;&#125;&#125;&gt;</span>&#123;rowData.Source&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginRight:0,marginTop:10,fontSize:</span> <span class="attr">13</span>, <span class="attr">color:</span> &#x27;#<span class="attr">999999</span>&#x27;&#125;&#125;&gt;</span>&#123;rowData.PublishTime&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:1</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">TouchableOpacity</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> images = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> imagesList) &#123;</span><br><span class="line">    <span class="keyword">let</span> dic = imagesList[index]</span><br><span class="line">    images.<span class="title function_">push</span>(</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">Image</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">resizeMode</span>=<span class="string">&quot;cover&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;marginRight:</span> <span class="attr">10</span>, <span class="attr">marginLeft:</span> <span class="attr">index</span> == <span class="string">0</span> ? <span class="attr">10</span> <span class="attr">:</span> <span class="attr">0</span>, <span class="attr">marginTop:10</span>, <span class="attr">marginBottom:</span> <span class="attr">10</span>,<span class="attr">flex:1</span>, <span class="attr">height:</span> <span class="attr">90</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">source</span>=<span class="string">&#123;&#123;uri:dic.ImgPath&#125;&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        /&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">TouchableOpacity</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span>  <span class="attr">backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginLeft:</span> <span class="attr">10</span>, <span class="attr">marginTop:</span> <span class="attr">10</span>&#125;&#125;&gt;</span>&#123;rowData.Title&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;flexDirection:</span>&#x27;<span class="attr">row</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;images&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;flex:1,</span> <span class="attr">flexDirection:</span> &#x27;<span class="attr">row</span>&#x27;, <span class="attr">justifyContent:</span> &#x27;<span class="attr">space-between</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginLeft:</span> <span class="attr">10</span>, <span class="attr">marginBottom:</span> <span class="attr">10</span>,<span class="attr">fontSize:</span> <span class="attr">13</span>, <span class="attr">color:</span> &#x27;#<span class="attr">999999</span>&#x27;&#125;&#125;&gt;</span>&#123;rowData.Source&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginRight:10,fontSize:</span> <span class="attr">13</span>, <span class="attr">marginBottom:</span> <span class="attr">10</span>,<span class="attr">color:</span> &#x27;#<span class="attr">999999</span>&#x27;&#125;&#125;&gt;</span>&#123;rowData.PublishTime&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:1</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">TouchableOpacity</span>&gt;</span></span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>我这里的 <code>style</code> 没有进行整理，所以看着比较乱，正式开发中应该整理到 <code>styles</code> 里，看起来就简洁多了。</p>
<p>现在运行就可以显示第一页的数据了。</p>
<p>下篇文章处理上下拉刷新加载。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/18/RN_3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/18/RN_3/" class="post-title-link" itemprop="url">React Native (三)： 自定义视图</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-18 18:41:00" itemprop="dateCreated datePublished" datetime="2017-04-18T18:41:00+08:00">2017-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:18:42" itemprop="dateModified" datetime="2023-12-21T21:18:42+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<p>这次我们要做的仿 <code>新闻头条</code> 的首页的顶部标签列表，不要在意新闻内容。</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative3/IMG_1169.PNG?raw=true"></p>
<h2 id="1-请求数据"><a href="#1-请求数据" class="headerlink" title="1.请求数据"></a>1.请求数据</h2><p>首先做顶部的目录视图，首先我们先获取数据：</p>
<p>在 <code>Home.js</code> 中加入方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newscategory/list/index.html?clientid=1114283782&amp;v=1.1&#x27;</span></span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span>&#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET SUCCESS =&gt;&#x27;</span>,url, json)</span><br><span class="line"></span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR then =&gt;&#x27;</span>,url,e)</span><br><span class="line"></span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR=&gt;&#x27;</span>,url, <span class="string">&#x27;==&gt;&#x27;</span>,error)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>componentDidMount()</code>是在此页面加载完成后由系统调用。</p>
<p>用到的 <code>LOG</code> 需要在 <code>setup.js</code> 添加全局方法 :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>.<span class="property">LOG</span> = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(__DEV__)&#123;</span><br><span class="line">        <span class="comment">// debug模式</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;/------------------------------\\&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(...args);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\\------------------------------/&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> args[args.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// release模式</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>完整的生命周期可以看这个 <a target="_blank" rel="noopener" href="https://facebook.github.io/react/docs/react-component.html">文档</a></p>
<p>我们使用 <code>fetch</code> 进行请求数据，你也可以用 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/network.html#content">这里</a> 的方法进行请求数据。</p>
<p>注意在 <code>iOS</code> 中需要去 <code>Xcode</code> 打开 <code>ATS</code>。</p>
<h2 id="2-自定义视图"><a href="#2-自定义视图" class="headerlink" title="2.自定义视图"></a>2.自定义视图</h2><p>在 <code>Home</code> 文件夹内创建 <code>SegmentedView.js</code></p>
<p>先定义一个基础的 <code>View</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Dimensions</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"><span class="keyword">const</span> &#123;width, height&#125; = <span class="title class_">Dimensions</span>.<span class="title function_">get</span>(<span class="string">&#x27;window&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">SegmentedView</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; style &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.view,</span> <span class="attr">style</span>]&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">              </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">height</span>: <span class="number">50</span>,</span><br><span class="line">        <span class="attr">width</span>: width,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<p>这里的 <code>const &#123;width, height&#125; = Dimensions.get(&#39;window&#39;)</code> 是获取到的屏幕的宽和高。</p>
<p>然后在 <code>Home.js</code> 加入 <code>SegmentedView</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">SegmentedView</span> <span class="keyword">from</span> <span class="string">&#x27;./SegmentedView&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;首页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">unLeftImage</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SegmentedView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>SegmentedView</code> 中 <code>const &#123; style &#125; = this.props</code> 获取到的就是这里设置的 <code>style=&#123;height: 30&#125;</code> 。</p>
<p> <code>&lt;View style=&#123;[styles.view, style]&#125;&gt;</code> 这样设置样式，数组中的每一个样式都会覆盖它前面的样式，不过只会覆盖有的 <code>key-value</code>，比如这里 <code>style=&#123;height: 30&#125;</code> ，它只会覆盖掉前面的 <code>height</code> ，最终的样式为 :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">height</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="attr">width</span>: width,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>


<h2 id="3-传数据"><a href="#3-传数据" class="headerlink" title="3.传数据"></a>3.传数据</h2><p>请求到的数据需要传给 <code>SegmentedView</code> 来创建视图，我们在 <code>Home.js</code> 加入构造，现在的 <code>Home.js</code> 是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NavigationBar</span> <span class="keyword">from</span> <span class="string">&#x27;../Custom/NavBarCommon&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">SegmentedView</span> <span class="keyword">from</span> <span class="string">&#x27;./SegmentedView&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Home</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造</span></span><br><span class="line">      <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="comment">// 初始状态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">list</span>: <span class="literal">null</span></span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newscategory/list/index.html?clientid=1114283782&amp;v=1.1&#x27;</span></span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span>&#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET SUCCESS =&gt;&#x27;</span>,url, json)</span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                            <span class="attr">list</span>: json.<span class="property">CategoryList</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR then =&gt;&#x27;</span>,url,e)</span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR=&gt;&#x27;</span>,url, <span class="string">&#x27;==&gt;&#x27;</span>,error)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;首页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">unLeftImage</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SegmentedView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">list</span>=<span class="string">&#123;this.state.list&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<p>再数据请求完成后调用 <code>setState()</code> ，系统会收集需要更改的地方然后刷新页面，所以这个方法永远是异步的。</p>
<p>现在请求完数据后就会把数组传给 <code>SegmentedView</code> 了。</p>
<p>再看 <code>SegmentedView</code> ，我们需要用一个 <code>ScrollView</code> 来放置这些标签：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">TouchableOpacity</span>,</span><br><span class="line">    <span class="title class_">Dimensions</span>,</span><br><span class="line">    <span class="title class_">ScrollView</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;width, height&#125; = <span class="title class_">Dimensions</span>.<span class="title function_">get</span>(<span class="string">&#x27;window&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一 屏最大数量, 为了可以居中请设置为 奇数</span></span><br><span class="line"><span class="keyword">const</span> maxItem = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">SegmentedView</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造</span></span><br><span class="line">      <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">       <span class="comment">// 初始状态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">itemHeight</span>: <span class="number">50</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (props.<span class="property">style</span> &amp;&amp; props.<span class="property">style</span>.<span class="property">height</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">                  ...<span class="variable language_">this</span>.<span class="property">state</span>,</span><br><span class="line">                  <span class="attr">itemHeight</span>: props.<span class="property">style</span>.<span class="property">height</span>,  <span class="comment">//如果在使用的地方设置了高度,那么保存起来方便使用</span></span><br><span class="line">              &#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">_getItems</span> = <span class="variable language_">this</span>.<span class="property">_getItems</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_getItems</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; list &#125; = <span class="variable language_">this</span>.<span class="property">props</span>  <span class="comment">//获取到 传入的数组</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!list || list.<span class="property">length</span> == <span class="number">0</span>) <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 计算每个标签的宽度</span></span><br><span class="line">        <span class="keyword">let</span> itemWidth = width / list.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list.<span class="property">length</span> &gt; maxItem) &#123;</span><br><span class="line">            itemWidth = width / maxItem</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> items = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = list[index]</span><br><span class="line">            items.<span class="title function_">push</span>(</span><br><span class="line">                <span class="language-xml"><span class="tag">&lt;<span class="name">View</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">this.state.itemHeight</span>, <span class="attr">width:</span> <span class="attr">itemWidth</span>, <span class="attr">alignItems:</span> &#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;,<span class="attr">backgroundColor:</span>&#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    &#123;/* justifyContent: 主轴居中, alignItems: 次轴居中 */&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Text</span>&gt;</span>&#123;dic.NameCN&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> items</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; style &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.view,</span> <span class="attr">style</span>]&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ScrollView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;styles.scrollView&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">horizontal</span>=<span class="string">&#123;true&#125;</span> //<span class="attr">横向显示</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">showsHorizontalScrollIndicator</span>=<span class="string">&#123;false&#125;</span> //<span class="attr">隐藏横向滑动条</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    &#123;this._getItems()&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">height</span>: <span class="number">50</span>,</span><br><span class="line">        <span class="attr">width</span>: width,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">scrollView</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;#EEEEEE&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="4-使标签可选并改变偏移量"><a href="#4-使标签可选并改变偏移量" class="headerlink" title="4.使标签可选并改变偏移量"></a>4.使标签可选并改变偏移量</h2><p>现在运行已经可以显示出标签列表了，我们还需要能点击，有选中和未选中状态，所以我们把数组中添加的视图封装一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123;itemHeight, itemWidth, dic&#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">TouchableOpacity</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">itemHeight</span>, <span class="attr">width:</span> <span class="attr">itemWidth</span>, <span class="attr">alignItems:</span> &#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;,<span class="attr">backgroundColor:</span>&#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/* justifyContent: 主轴居中, alignItems: 次轴居中 */&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Text</span>&gt;</span>&#123;dic.NameCN&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">TouchableOpacity</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们需要可以点击，所以把 <code>View</code> 换成了 <code>TouchableOpacity</code>，记得在顶部导入。</p>
<p>然后修改数组的 <code>push</code> 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">items.<span class="title function_">push</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Item</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">itemHeight</span>=<span class="string">&#123;this.state.itemHeight&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">itemWidth</span>=<span class="string">&#123;itemWidth&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span>   </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    /&gt;</span></span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>现在运行已经可以点击了，接下来设置选中和未选中样式，在 <code>Item</code> 内加入:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="comment">// 初始状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">        <span class="attr">isSelect</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>Text</code> 加入样式:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Text</span> style=&#123;&#123;<span class="attr">color</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isSelect</span> ? <span class="string">&#x27;red&#x27;</span> : <span class="string">&#x27;black&#x27;</span>&#125;&#125;&gt;&#123;dic.<span class="property">NameCN</span>&#125;&lt;/<span class="title class_">Text</span>&gt;</span><br></pre></td></tr></table></figure>

<p>在 <code>TouchableOpacity</code> 加入点击事件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">TouchableOpacity</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">height</span>: itemHeight, <span class="attr">width</span>: itemWidth, <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>, <span class="attr">justifyContent</span>:<span class="string">&#x27;center&#x27;</span>,<span class="attr">backgroundColor</span>:<span class="string">&#x27;#EEEEEE&#x27;</span>&#125;&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">isSelect</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在标签已经可以进行点击，点击后变红，我们需要处理点击后让上一个选中的变为未选中，我们给 <code>Item</code> 加一个方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_unSelect</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isSelect</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还需要接收一个回调函数: <code>onPress</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;itemHeight, itemWidth, dic, onPress&#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">    </span><br><span class="line"> &lt;<span class="title class_">TouchableOpacity</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">height</span>: itemHeight, <span class="attr">width</span>: itemWidth, <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>, <span class="attr">justifyContent</span>:<span class="string">&#x27;center&#x27;</span>,<span class="attr">backgroundColor</span>:<span class="string">&#x27;#EEEEEE&#x27;</span>&#125;&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        onPress &amp;&amp; <span class="title function_">onPress</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">isSelect</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>


<p>现在去 <code>items.push</code> 加入 <code>onPress</code> ，我们还需要一个状态 <code>selectItem</code> 来记录选中的标签:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 初始状态</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">    <span class="attr">itemHeight</span>: <span class="number">50</span>,</span><br><span class="line">    <span class="attr">selectItem</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Item</span></span><br><span class="line">    ref=&#123;index&#125;  <span class="comment">//设置 ref 以供获取自己</span></span><br><span class="line">    key=&#123;index&#125;</span><br><span class="line">    itemHeight=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">itemHeight</span>&#125;</span><br><span class="line">    itemWidth=&#123;itemWidth&#125;</span><br><span class="line">    dic=&#123;dic&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>() <span class="comment">//让已经选中的标签变为未选中</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]  <span class="comment">//获取到点击的标签</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>现在运行，就可以选中的时候取消上一个标签的选中状态了，但是我们需要默认选中第一个标签。</p>
<p>我们给 <code>Item</code> 加一个属性 <code>isSelect</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Item</span></span><br><span class="line">    ref=&#123;index&#125;  <span class="comment">//设置 ref 以供获取自己</span></span><br><span class="line">    key=&#123;index&#125;</span><br><span class="line">    isSelect=&#123;index == <span class="number">0</span>&#125;</span><br><span class="line">    itemHeight=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">itemHeight</span>&#125;</span><br><span class="line">    itemWidth=&#123;itemWidth&#125;</span><br><span class="line">    dic=&#123;dic&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>() <span class="comment">//让已经选中的标签变为未选中</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]  <span class="comment">//获取到点击的标签</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>修改 <code>Item</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">   <span class="variable language_">super</span>(props);</span><br><span class="line">   <span class="comment">// 初始状态</span></span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">       <span class="attr">isSelect</span>: props.<span class="property">isSelect</span></span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure>

<p> 现在运行发现第一项已经默认选中，但是点击别的标签，发现第一项并没有变成未选中，这是因为 <code>this.state.selectItem</code> 初始值为 <code>null</code>，那我们需要把第一项标签赋值给它。</p>
<p>由于只有在视图加载或更新完成才能通过 <code>refs</code> 获取到某个视图，所以我们需要一个定时器去触发选中方法。</p>
<p>去 <code>Item</code> 的 <code>constructor()</code> 加入定时器:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">   <span class="variable language_">super</span>(props);</span><br><span class="line">   <span class="comment">// 初始状态</span></span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">       <span class="attr">isSelect</span>: props.<span class="property">isSelect</span></span><br><span class="line">   &#125;;</span><br><span class="line">   </span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">timer</span> = <span class="built_in">setTimeout</span>(</span><br><span class="line">      <span class="function">() =&gt;</span> </span><br><span class="line">          props.<span class="property">isSelect</span> &amp;&amp; props.<span class="property">onPress</span> &amp;&amp; props.<span class="title function_">onPress</span>() <span class="comment">//100ms 后调用选中操作</span></span><br><span class="line">      ,</span><br><span class="line">      <span class="number">100</span></span><br><span class="line">    ); </span><br><span class="line">&#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
<p>搞定，最后我们还需要点击靠后的标签可以自动居中，我们需要操作 <code>ScrollView</code> 的偏移量，给 <code>ScrollView</code> 设置 <code>ref=&#39;ScrollView&#39;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;<span class="title class_">ScrollView</span></span><br><span class="line">    ref=<span class="string">&quot;ScrollView&quot;</span></span><br><span class="line">    style=&#123;styles.<span class="property">scrollView</span>&#125;</span><br><span class="line">    horizontal=&#123;<span class="literal">true</span>&#125;</span><br><span class="line">    showsHorizontalScrollIndicator=&#123;<span class="literal">false</span>&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>


<p>然后去 <code>items.push</code> 加入偏移量的设置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Item</span></span><br><span class="line">    ref=&#123;index&#125;</span><br><span class="line">    key=&#123;index&#125;</span><br><span class="line">    isSelect=&#123;index == <span class="number">0</span>&#125;</span><br><span class="line">    itemHeight=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">itemHeight</span>&#125;</span><br><span class="line">    itemWidth=&#123;itemWidth&#125;</span><br><span class="line">    dic=&#123;dic&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list.<span class="property">length</span> &gt; maxItem) &#123;</span><br><span class="line">            <span class="keyword">let</span> meiosis = <span class="built_in">parseInt</span>(maxItem / <span class="number">2</span>)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">x</span>: (index - meiosis &lt; <span class="number">0</span> ? <span class="number">0</span> : index - meiosis &gt; list.<span class="property">length</span> - maxItem ? list.<span class="property">length</span> - maxItem : index - meiosis ) * itemWidth, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">animated</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>


<p>现在的效果:</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative3/effect.gif?raw=true" alt="effect"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative3">项目地址</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/17/RN_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/17/RN_2/" class="post-title-link" itemprop="url">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-17 18:16:00" itemprop="dateCreated datePublished" datetime="2017-04-17T18:16:00+08:00">2017-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:17:54" itemprop="dateModified" datetime="2023-12-21T21:17:54+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative2">项目地址</a></p>
<h2 id="React-Native-App-的视图结构"><a href="#React-Native-App-的视图结构" class="headerlink" title="React Native App 的视图结构"></a>React Native App 的视图结构</h2><p>首先把 <code>setup.js</code> 的 <code>Root</code> 以及 布局 的代码改一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">					</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">container</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>




<p><code>React Native</code> 的所有界面都是在一个主视图上，这里的这个 <code>&lt;View&gt;</code> 跟 <code>iOS</code> 中的 <code>Window</code> 是同样的，这里跟 <code>Android</code> 不太一样。</p>
<p>当然运行在 <code>iOS</code> 和 <code>Android</code> 中还是以 <code>ViewController</code> 和 <code>Activity</code> 展示的。</p>
<h2 id="StatusBar"><a href="#StatusBar" class="headerlink" title="StatusBar"></a>StatusBar</h2><p><code>iOS</code> 和 <code>Android</code> 的 <code>StatusBar</code> 是差不多的，都是顶部那高度 20 的部分，用来显示信号、电量等系统的信息。</p>
<p>在 <code>setup.js</code> 中加入 <code>StatusBar</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StatusBar</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">StatusBar</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">barStyle</span>=<span class="string">&#123;</span>&#x27;<span class="attr">light-content</span>&#x27;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">backgroundColor</span>=<span class="string">&#123;</span>&#x27;#<span class="attr">000000</span>&#x27;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>StatusBar</code> 的配置可以看<a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/statusbar.html#content">这里</a>，注意有些属性只针对特定平台。</p>
<p>这样可以设置整个 <code>App</code> 中 <code>StatusBar</code> 的样式，如果有某个页面 <code>A</code> 的 <code>StatusBar</code> 需要特殊处理，那么就在 <code>A</code> 页面加入 <code>StatusBar</code> 进行设置。</p>
<h2 id="Navigator"><a href="#Navigator" class="headerlink" title="Navigator"></a>Navigator</h2><p>我们需要用 <code>Navigator</code> 来让整个 <code>App</code> 可以在页面之间跳转。</p>
<p><code>Navigator</code> 和 <code>iOS</code> 的一样，都是对页面进行 <code>push</code> 和 <code>pop</code> ，跟 <code>Android</code> 的 <code>NavigationView</code> 不是一个东西。</p>
<p>官方文档在<a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/navigator.html#content">这里</a></p>
<p>现在在 <code>App</code> 文件夹内创建一个新的文件 <code>App.js</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">Text</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		<span class="tag">&lt;<span class="name">Text</span>&gt;</span>main<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">        <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>然后在 <code>setup</code> 内 <code>StatusBar</code> 下面加入 <code>Navigator</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;<span class="title class_">Navigator</span></span><br><span class="line">    initialRoute=&#123;&#123; <span class="attr">component</span>: <span class="title class_">App</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line">    style=&#123;&#123;<span class="attr">flex</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">    renderScene=&#123;<span class="function">(<span class="params">route, navigator</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">BackAndroid</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;hardwareBackPress&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(navigator == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(navigator.<span class="title function_">getCurrentRoutes</span>().<span class="property">length</span> === <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            navigator.<span class="title function_">pop</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">Component</span> = route.<span class="property">component</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...route.params</span>&#125; <span class="attr">navigator</span>=<span class="string">&#123;navigator&#125;/</span>&gt;</span></span></span><br><span class="line">        <span class="comment">//  上面的route.params 是为了方便后续界面间传递参数用的</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中 <code>initialRoute</code> 设置了 <code>component</code> ，是最底层的第一个页面。</p>
<p>然后 <code>renderScene</code> 控制 <code>push</code> 的时候做哪些操作，这里的 <code>BackAndroid.addEventListener</code> 是监听了 <code>Android</code> 的物理返回按键。</p>
<p>现在运行可以看见页面中间有个 <code>main</code> ：</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative2/main.png?raw=true"></p>
<p>你可能会发现为什么没 <code>NavigationBar</code> 呢，我们后面再加。</p>
<h2 id="tab-navigator"><a href="#tab-navigator" class="headerlink" title="tab-navigator"></a>tab-navigator</h2><p>官方并没有 <code>TabBar</code> ，我们使用一个第三方 <a target="_blank" rel="noopener" href="https://github.com/expo/react-native-tab-navigator">react-native-tab-navigator</a></p>
<p>在项目根目录执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install react-native-tab-navigator --save</span><br></pre></td></tr></table></figure>

<p>安装完成后在 <code>App.js</code> 加入 <code>TabNavigator</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">const home_key = &#x27;home&#x27;</span><br><span class="line">const satin_key = &#x27;satin&#x27;</span><br><span class="line">const setting_key = &#x27;setting&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import Home from &#x27;./Home/Home&#x27;</span><br><span class="line">import Satin from &#x27;./Satin/Satin&#x27;</span><br><span class="line">import Setting from &#x27;./Setting/Setting&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;TabNavigator&gt;</span><br><span class="line">	&lt;TabNavigator.Item</span><br><span class="line">	    selected=&#123;this.state.selectedTab === home_key&#125;</span><br><span class="line">	    title=&quot;首页&quot;</span><br><span class="line">	    titleStyle=&#123;styles.tabText&#125;</span><br><span class="line">	    selectedTitleStyle=&#123;styles.selectedTabText&#125;</span><br><span class="line">	    renderIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/home_unselect.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    renderSelectedIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/home_select.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    onPress=&#123;() =&gt; this.setState(&#123; selectedTab: home_key &#125;)&#125;&gt;</span><br><span class="line">	</span><br><span class="line">	    &lt;Home navigator=&#123;this.props.navigator&#125;/&gt;</span><br><span class="line">	&lt;/TabNavigator.Item&gt;</span><br><span class="line">	&lt;TabNavigator.Item</span><br><span class="line">	    selected=&#123;this.state.selectedTab === satin_key&#125;</span><br><span class="line">	    title=&quot;段子&quot;</span><br><span class="line">	    titleStyle=&#123;styles.tabText&#125;</span><br><span class="line">	    selectedTitleStyle=&#123;styles.selectedTabText&#125;</span><br><span class="line">	    renderIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/activity_unselect.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    renderSelectedIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/activity_select.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    onPress=&#123;() =&gt; this.setState(&#123; selectedTab: satin_key &#125;)&#125;&gt;</span><br><span class="line">	</span><br><span class="line">	    &lt;Satin navigator=&#123;this.props.navigator&#125;/&gt;</span><br><span class="line">	&lt;/TabNavigator.Item&gt;</span><br><span class="line">	&lt;TabNavigator.Item</span><br><span class="line">	    selected=&#123;this.state.selectedTab === setting_key&#125;</span><br><span class="line">	    title=&quot;我的&quot;</span><br><span class="line">	    titleStyle=&#123;styles.tabText&#125;</span><br><span class="line">	    selectedTitleStyle=&#123;styles.selectedTabText&#125;</span><br><span class="line">	    renderIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/my_unselect.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    renderSelectedIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/my_select.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    onPress=&#123;() =&gt; this.setState(&#123; selectedTab: setting_key &#125;)&#125;&gt;</span><br><span class="line">	</span><br><span class="line">	    &lt;Setting navigator=&#123;this.props.navigator&#125;/&gt;</span><br><span class="line">	&lt;/TabNavigator.Item&gt;</span><br><span class="line">&lt;/TabNavigator&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置也比较易懂。</p>
<p>另外创建 3 个文件 <code>Home.js</code> 、 <code>Satin.js</code> 和 <code>Setting.js</code> </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Satin</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;orange&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以给每个设置不同的颜色，这样点击界面切换也很明显。</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative2/tab.png?raw=true"></p>
<p>具体的代码可以看 <a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative2">项目</a></p>
<h2 id="NavigationBar"><a href="#NavigationBar" class="headerlink" title="NavigationBar"></a>NavigationBar</h2><p>同意官方也没有提供 <code>NavigationBar</code>，我们需要自定义一个。</p>
<p>然后在 <code>Home.js</code> 、  <code>Satin.js</code> 和 <code>Setting.js</code> 加入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NavigationBar</span> <span class="keyword">from</span> <span class="string">&#x27;../Custom/NavBarCommon&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Home</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;首页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">unLeftImage</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative2/navibar.png?raw=true" alt="navibar"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative2">项目地址</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/14/RN_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/14/RN_1/" class="post-title-link" itemprop="url">React Native (一)：基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-14 17:05:00" itemprop="dateCreated datePublished" datetime="2017-04-14T17:05:00+08:00">2017-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:17:20" itemprop="dateModified" datetime="2023-12-21T21:17:20+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<p>最近刚完成一个 <code>React Native</code> 的项目，踩了无数坑，去年折腾过几周，后来因为有两个 <code>iOS</code> 项目就没有再折腾，当时想要写一个主文件，分别给 <code>Android</code> 和 <code>iOS</code> 引用，但是弄了好久也不会弄，也下载了 <a target="_blank" rel="noopener" href="https://github.com/fbsamples/f8app"><code>f8app</code></a> 看了，不过完全看不懂，就这样放弃了。</p>
<p>今年 3 月中旬正好公司有个项目只需要前端，而且公司没有 <code>Android</code> 开发，也想弄混合开发，于是正好我拿这个项目去练手。</p>
<p>从上面的描述也看出来我是一个 <code>iOS</code> 开发，对于有移动开发基础的人来说做 <code>React Native</code> 开发还是比较好上手的，前端的话更容易，只是刚开始入门比较费劲，也找不到个能问的人。总的下来我的建议还是如果卡在某个地方很久很烦躁不想继续学了，那么放一放，放几天或者一两周，再继续学，不要轻易放弃，入门后就轻松多了。</p>
<h2 id="1-说明"><a href="#1-说明" class="headerlink" title="1.说明"></a>1.说明</h2><p>这系列文章主要还是针对有编程经验的开发者，起码掌握一门主流的编程语言。</p>
<p>开发平台： Mac OS</p>
<p>IDE: WebStorm</p>
<p>这里我并不会很详细的一步一步的讲解，详细的教程可以看<a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/getting-started.html">官方教程</a>，这里主要是记录一些我在学习过程中遇到的疑难杂症，如果你碰到了或许可以帮你一把。</p>
<h2 id="2-基础"><a href="#2-基础" class="headerlink" title="2.基础"></a>2.基础</h2><p>首先既然看这个文章，那么默认你已经知道什么是 <a target="_blank" rel="noopener" href="http://reactnative.cn/">React Native</a> 以及是干什么的，还有你需要会一些 <code>JavaScript</code> ，如果你还不会 <code>JavaScript </code>，那么推荐 <code>廖雪峰老师</code> 的 <a target="_blank" rel="noopener" href="http://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000">JavaScript教程</a> 和 <code>阮一峰老师</code> 的 <a target="_blank" rel="noopener" href="http://es6.ruanyifeng.com/#README">ECMAScript 6 入门</a>。</p>
<p>官方文档永远是必看的，对于初学者来说不会的先去官方文档找。<a target="_blank" rel="noopener" href="http://reactnative.cn/">React Native中文网</a> 对于英文不好的同学来说是首选，比如我自己。</p>
<p>有问题也可以去 <code>React Native</code> 的 <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native">GitHub地址</a> 的 <code>issues</code> 找。</p>
<h2 id="3-搭建开发环境"><a href="#3-搭建开发环境" class="headerlink" title="3.搭建开发环境"></a>3.搭建开发环境</h2><p>这部分比较简单，按着 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/getting-started.html">官方教程</a> 搭建即可，但是在运行命令的时候可能会出各种问题，这个时候只能靠 <code>Baidu</code> 和 <code>Google</code> 了，我是一次成功的，所以也不知道会有什么问题，这里也不做过多说明了。</p>
<p>希望没人在这一步就放弃了。</p>
<h2 id="4-iOS-和-Android-调用统一资源"><a href="#4-iOS-和-Android-调用统一资源" class="headerlink" title="4.iOS 和 Android 调用统一资源"></a>4.iOS 和 Android 调用统一资源</h2><p>新创建的项目 <code>iOS</code> 和 <code>Android</code> 代码是分开的，分别在 <code>index.ios.js</code> 和 <code>index.android.js</code> 中，这是两个平台的入口。</p>
<p>顶部的各种 <code>import</code> 是引入的各种资源：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">AppRegistry</span>,</span><br><span class="line">  <span class="title class_">StyleSheet</span>,</span><br><span class="line">  <span class="title class_">Text</span>,</span><br><span class="line">  <span class="title class_">View</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>接下来是 <code>React</code> 的语法，创建了一些视图:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ReactNative1</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.welcome&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          Welcome to React Native!</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          To get started, edit index.ios.js</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          Press Cmd+R to reload,&#123;&#x27;\n&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">          Cmd+D or shake for dev menu</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是布局的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">container</span>: &#123;</span><br><span class="line">    <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="string">&#x27;#F5FCFF&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">welcome</span>: &#123;</span><br><span class="line">    <span class="attr">fontSize</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">margin</span>: <span class="number">10</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">instructions</span>: &#123;</span><br><span class="line">    <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#333333&#x27;</span>,</span><br><span class="line">    <span class="attr">marginBottom</span>: <span class="number">5</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>最后是注册，每个平台只需要注册一次：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">AppRegistry</span>.<span class="title function_">registerComponent</span>(<span class="string">&#x27;ReactNative1&#x27;</span>, <span class="function">() =&gt;</span> <span class="title class_">ReactNative1</span>);</span><br></pre></td></tr></table></figure>

<p>上面的那一大堆不用去管，我们就从这个方法入手，这个方法传入了 2 个参数，第一个是 <code>App</code> 的标志，这个你们应该也明白不能随便改，第二个参数是一个匿名方法，调用这个方法会返回 <code>ReactNative1</code> ，就是上面的 <code>React</code> 创建的类，那么要让 <code>iOS</code> 和 <code>Android</code> 引用同一个资源，只需要这里返回给同一个类即可。</p>
<p>新创建一个文件夹 <code>App</code> 或者随便啥，我们写的所有 <code>JS</code> 文件都放这里，方便管理。</p>
<p>然后在 <code>App</code> 内创建一个 <code>setup.js</code>，这时候目录看起来是这样子:</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/directory.jpeg?raw=true" alt="目录"></p>
<p>然后在把 <code>index.ios.js</code> 的 <code>import</code> 、 <code>React</code> 和 <code>布局</code> 部分的内容复制过来，然后加入两句代码，现在 <code>setup.js</code> 文件是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">View</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params"></span>): <span class="title class_">ReactClass</span>&lt;&#123;&#125;&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里做一些注册第三方等App初始化需要的操作</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Root</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.welcome&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    Welcome to React Native!</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    To get started, edit index.android.js</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    Double tap R on your keyboard to reload,&#123;&#x27;\n&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">                    Shake or press menu button for dev menu</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">container</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;#F5FCFF&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">welcome</span>: &#123;</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="number">20</span>,</span><br><span class="line">        <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">margin</span>: <span class="number">10</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">instructions</span>: &#123;</span><br><span class="line">        <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#333333&#x27;</span>,</span><br><span class="line">        <span class="attr">marginBottom</span>: <span class="number">5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = setup</span><br></pre></td></tr></table></figure>

<p>我这里是直接导入了 <code>import React from &#39;react&#39;</code> ，那么在创建 <code>React类</code> 的时候就需要 <code>extends React.Component</code> ，我是习惯这种写法，如果你觉得官方的写法比较好，那么就按着官方的写就行。</p>
<p>然后修改 <code>index.ios.js</code> 和 <code>index.android.js</code> ,修改成一模一样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">AppRegistry</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> setup <span class="keyword">from</span> <span class="string">&#x27;./App/setup&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">AppRegistry</span>.<span class="title function_">registerComponent</span>(<span class="string">&#x27;ReactNative1&#x27;</span>, setup);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果已经在运行，那么 <code>iOS模拟器</code> 按 <code>command + R</code> 刷新，<code>Android模拟器</code> 双击 <code>R</code> 刷新。</p>
<p>如果没有在运行那么运行 <code>react-native run-ios</code> 和 <code>react-native run-android</code> 查看效果。</p>
<p>如果运行的时候遇见这个错误：</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/firstError.png?raw=true" alt="firstError"></p>
<p>那么需要关闭 <code>react-native</code> 启动的服务，重新启动。</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/iterm.jpeg?raw=true" alt="iterm"></p>
<p>如果一切正常，那么尝试修改 <code>setup.js</code> 中 <code>Text</code> 标签中的文字，刷新 <code>iOS</code> 和 <code>Android</code> 看看效果。</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/ios.png?raw=true"><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/android.png?raw=true"></p>
<p>如果你坚持到了这里，那么恭喜你已经初步掌握了 <code>react native</code> 。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative1">示例项目地址</a></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://github.com/fbsamples/f8app">f8app</a></p>
<p><a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/getting-started.html">React Native中文网</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/issues/6613">https://github.com/facebook/react-native/issues/6613</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/01/21/AndroidAddBaiduMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/21/AndroidAddBaiduMap/" class="post-title-link" itemprop="url">Android 添加百度地图的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-21 12:03:00" itemprop="dateCreated datePublished" datetime="2017-01-21T12:03:00+08:00">2017-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-04-13 18:45:00" itemprop="dateModified" datetime="2017-04-13T18:45:00+08:00">2017-04-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>好久没写东西了，一直在忙着学 <code>React native</code>。</p>
<p>今天给 <code>Android</code> 导入<code>百度地图</code> 的时候遇见定位监听不回调的问题，记录一下。</p>
<p>电脑系统：Mac OS 10.12.4</p>
<p>IDE： Android Studio 2.1.2</p>
<p>JRE: 1.8.0_121-b13 x86_64</p>
<p>手机：Mi-4c   </p>
<p>Android Version:  5.1.1LMY47V</p>
<h4 id="1-确定-百度key-设置正确"><a href="#1-确定-百度key-设置正确" class="headerlink" title="1.确定 百度key 设置正确"></a>1.确定 <code>百度key</code> 设置正确</h4><p><code>meta-data </code> 要放在 <code>application</code> 里面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;application&gt;  </span><br><span class="line">    &lt;meta-data  </span><br><span class="line">        android:name=&quot;com.baidu.lbsapi.API_KEY&quot;  </span><br><span class="line">        android:value=&quot;开发者 key&quot; /&gt;  </span><br><span class="line">&lt;/application&gt;</span><br></pre></td></tr></table></figure>


<h4 id="2-确定权限都添加"><a href="#2-确定权限都添加" class="headerlink" title="2.确定权限都添加"></a>2.确定权限都添加</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.SYSTEM_ALERT_WINDOW&quot;/&gt;</span><br><span class="line">&lt;!-- 这个权限用于进行网络定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 这个权限用于访问GPS定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 用于访问wifi网络信息，wifi信息会用于进行网络定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_WIFI_STATE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 获取运营商信息，用于支持提供运营商信息相关的接口--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 这个权限用于获取wifi的获取权限，wifi信息会用来进行网络定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.CHANGE_WIFI_STATE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 用于读取手机当前的状态--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 写入扩展存储，向扩展卡写入数据，用于写入离线定位数据--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 访问网络，网络定位需要上网--&gt;</span><br><span class="line">&lt;!-- SD卡读取权限，用户写入离线定位数据--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="3-需要设置-service"><a href="#3-需要设置-service" class="headerlink" title="3. 需要设置 service"></a>3. 需要设置 <code>service</code></h4><p> 也放在 <code>application</code> 里面，后面的版本号与导入的 <code>百度SDK</code> 版本号一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;service android:name=&quot;com.baidu.location.f&quot; android:enabled=&quot;true&quot; android:process=&quot;:remote&quot;&gt;</span><br><span class="line">	  &lt;intent-filter&gt;</span><br><span class="line">	       &lt;action android:name=&quot;com.baidu.location.service_v4.3&quot; &gt;</span><br><span class="line">	        &lt;/action&gt;</span><br><span class="line">	  &lt;/intent-filter&gt;</span><br><span class="line">&lt;/service&gt;</span><br><span class="line">	       </span><br></pre></td></tr></table></figure>


<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://lbsyun.baidu.com/index.php?title=androidsdk">百度官方文档</a></p>
<p><a target="_blank" rel="noopener" href="http://bbs.lbsyun.baidu.com/forum.php?mod=viewthread&tid=10847">http://bbs.lbsyun.baidu.com/forum.php?mod=viewthread&tid=10847</a></p>
<p><a target="_blank" rel="noopener" href="http://bbs.csdn.net/topics/390803526">http://bbs.csdn.net/topics/390803526</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/01/21/UMWXNotCallBack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/21/UMWXNotCallBack/" class="post-title-link" itemprop="url">友盟微信支付不回调</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-21 12:03:00" itemprop="dateCreated datePublished" datetime="2017-01-21T12:03:00+08:00">2017-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-02-11 10:23:00" itemprop="dateModified" datetime="2017-02-11T10:23:00+08:00">2017-02-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是友盟 <code>UMSocialSnsService.h</code> 里的一个处理回调的方法</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> Deprecated API</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> 处理app的URL方法</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @param url 传入的url</span></span><br><span class="line"><span class="comment"> </span></span><br><span class="line"><span class="comment"> @return wxApiDelegate 实现微信代理对象</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+(<span class="type">BOOL</span>)handleOpenURL:(<span class="built_in">NSURL</span> *)url wxApiDelegate:(<span class="type">id</span>&lt;WXApiDelegate&gt;)wxApiDelegate;</span><br></pre></td></tr></table></figure>

<p>使用发现这个 <code>wxApiDelegate</code> 即使设置了也不会执行 <code>&lt;WXApiDelegate&gt;</code> 里的方法。</p>
<p>所以在微信支付的时候需要进行判断，使用微信SDK的方法设置代理。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  AppDelegate 中 支付回调信息处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">+ (<span class="type">BOOL</span>)payCommleteWithOpenURL:(<span class="built_in">NSURL</span> *)url</span><br><span class="line">&#123;</span><br><span class="line">    GPPayTool * payTool = [GPPayTool shareGPPayTool];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ([url.host isEqualToString:<span class="string">@&quot;uppayresult&quot;</span>]) &#123;</span><br><span class="line">        [payTool unionPayOpenURL:url];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([url.host isEqualToString:<span class="string">@&quot;safepay&quot;</span>]) &#123;</span><br><span class="line">        [payTool aliPayOpenURL:url];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([url.host isEqualToString:<span class="string">@&quot;pay&quot;</span>]) &#123;</span><br><span class="line">       <span class="keyword">return</span> [WXApi handleOpenURL:url delegate:payTool];</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> [UMSocialSnsService handleOpenURL:url];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我直接判断 <code>host</code> 是否为 <code>pay</code>，可能会跟别的第三方回调重复，保险起见你应该打印一下 这个 <code>url</code> ，可以看到微信支付的 <code>url</code> 格式为 <code>wx000000000://pay/?code=031i50Wd2tYa3R0cL9Ud2bGYVd2i50WE&amp;state=</code>， <code>wx000000000</code> 这里是你的微信的 <code>AppId</code>，你应该判断是否等于 &#96;&#96;wx000000000:&#x2F;&#x2F;pay&#96;: </p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[url.absoluteString isEqualToString:<span class="string">@&quot;wx000000000://pay]&quot;</span></span><br></pre></td></tr></table></figure>

<p>别学我。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/01/21/swiftExploreAndOptimization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/21/swiftExploreAndOptimization/" class="post-title-link" itemprop="url">Swift 性能探索和优化分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-21 12:03:00" itemprop="dateCreated datePublished" datetime="2017-01-21T12:03:00+08:00">2017-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 20:38:48" itemprop="dateModified" datetime="2023-12-21T20:38:48+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://onevcat.com/2016/02/swift-performance/">原文地址</a></p>
<p>Apple 在推出 Swift 时就将其冠以先进，安全和高效的新一代编程语言之名。前两点在 Swift 的语法和语言特性中已经表现得淋漓尽致：像是尾随闭包，枚举关联值，可选值和强制的类型安全等都是 Swift 显而易见的优点。但是对于高效一点，就没有那么明显了。在 2014 年 WWDC 大会上 Apple 宣称 Swift 具有超越 Objective-C 的性能，甚至某些情况下可以媲美和超过 C。但是在 Swift 正式发布后，很多开发者发现似乎 Swift 性能并没有像宣传的那样优秀。甚至在 Swift 经过了一年半的演进的今天，稍有不慎就容易掉进语言性能的陷阱中。本文将分析一些使用 Swift 进行 iOS&#x2F;OS X 开发时性能上的考量和做法，同时，笔者结合自己这一年多来使用 Swift 进行开发的经验，也给出了一些对应办法。</p>
<h2 id="为什么-Swift-的性能值得期待"><a href="#为什么-Swift-的性能值得期待" class="headerlink" title="为什么 Swift 的性能值得期待"></a>为什么 Swift 的性能值得期待</h2><p>Swift 具有一门高效语言所需要具备的绝大部分特点。与 Ruby 或者 Python 这样的解释型语言不需要再做什么对比了，相较于其前辈的 Objective-C，Swift 在编译期间就完成了方法的绑定，因此方法调用上不再是类似于 Smalltalk 的消息发送，而是直接获取方法地址并进行调用。虽然 Objective-C 对运行时查找方法的过程进行了缓存和大量的优化，但是不可否认 Swift 的调用方式会更加迅速和高效。</p>
<p>另外，与 Objective-C 不同，Swift 是一门强类型的语言，这意味 Swift 的运行时和代码编译期间的类型是一致的，这样编译器可以得到足够的信息来在生成中间码和机器码时进行优化。虽然都使用 LLVM 工具链进行编译，但是 Swift 的编译过程相比于 Objective-C 要多一个环节 – 生成 Swift 中间代码 (Swift Intermediate Language，SIL)。SIL 中包含有很多根据类型假定的转换，这为之后进一步在更低层级优化提供了良好的基础，分析 SIL 也是我们探索 Swift 性能的有效方法。</p>
<p>最后，Swift 具有良好的内存使用的策略和结构。Swift 标准库中绝大部分类型都是 struct，对值类型的使用范围之广，在近期的编程语言中可谓首屈一指。原本值类型不可变性的特点，往往导致对于值的使用和修改意味着创建新的对象，但是 Swift 巧妙地规避了不必要的值类型复制，而仅只在必要时进行内存分配。这使得 Swift 在享受不可变性带来的便利以及避免不必要的共享状态的同时，还能够保持性能上的优秀。</p>
<h2 id="对性能进行测试"><a href="#对性能进行测试" class="headerlink" title="对性能进行测试"></a>对性能进行测试</h2><p>《计算机程序设计艺术》和 TeX 的作者高德纳曾经在论文中说过：</p>
<blockquote>
<p>过早的优化是万恶之源。</p>
</blockquote>
<p>和很多人理解的不同，这并不是说我们不应该在项目的早期就开始进行优化，而是指我们需要弄清代码中性能真正的问题和希望达到的目标后再开始进行优化。因此，我们需要知道性能问题到底出在哪儿。对程序性能的测试一定是优化的第一步。</p>
<p>在 Cocoa 开发中，对于性能的测试有几种常见的方式。其中最简单是直接通过输出 log 来监测某一段程序运行所消耗的时间。在 Cocoa 中我们可以使用 <a target="_blank" rel="noopener" href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/CoreAnimation_functions/index.html#//apple_ref/c/func/CACurrentMediaTime">CACurrentMediaTime</a> 来获取精确的时间。这个方法将会调用 mach 底层的 mach_absolute_time()，它的返回是一个基于 <a target="_blank" rel="noopener" href="https://developer.apple.com/library/mac/qa/qa1398/_index.html">Mach absolute time unit</a> 的数字，我们通过在方法调用前后分别获取两次时刻，并计算它们的间隔，就可以了解方法的执行时间：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> start <span class="operator">=</span> <span class="type">CACurrentMediaTime</span>()</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">let</span> end <span class="operator">=</span> <span class="type">CACurrentMediaTime</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;测量时间：<span class="subst">\(end <span class="operator">-</span> start)</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>为了方便使用，我们还可以将这段代码封装到一个方法中，这样我们就能在项目中需要测试性能的地方方便地使用它了：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">measure</span>(<span class="params">f</span>: ()-&gt;()) &#123;</span><br><span class="line">    <span class="keyword">let</span> start <span class="operator">=</span> <span class="type">CACurrentMediaTime</span>()</span><br><span class="line">    f()</span><br><span class="line">    <span class="keyword">let</span> end <span class="operator">=</span> <span class="type">CACurrentMediaTime</span>()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;测量时间：<span class="subst">\(end <span class="operator">-</span> start)</span>&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">measure &#123;</span><br><span class="line">    doSomeHeavyWork()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CACurrentMediaTime</code> 和 log 的方法适合于我们对既有代码进行探索，另一种有效的方法是使用 Instruments 的 Time Profiler 来在更高层面寻找代码的性能弱点。将程序挂载到 Time Profiler 后，每一个方法调用的耗时都将被记录。</p>
<p>当我们寻找到需要进行优化的代码路径后，为其建立一个单元测试来持续地检测代码的性能是很好的做法。在 Xcode 中默认的测试框架 XCTest 提供了检测并汇报性能的方法：<code>measureBlock</code>。通过将测试的代码块放到 <code>measureBlock</code> 中，Xcode 在测试时就会多次运行这段代码，并统计平均耗时。更方便的是，你可以设定一个基准，Xcode 会记录每次的耗时并在性能没有达到预期时进行提醒。这保证了随着项目开发，关键的代码路径不会发生性能上的退化。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">testPerformance</span>() &#123;</span><br><span class="line">    measureBlock() &#123;</span><br><span class="line">        <span class="comment">// 需要性能测试的代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/img/swiftExploreAndOptimization/test-measure.png" alt="measure"></p>
<h2 id="优化手段，常见误用及对策"><a href="#优化手段，常见误用及对策" class="headerlink" title="优化手段，常见误用及对策"></a>优化手段，常见误用及对策</h2><h3 id="多线程、算法及数据结构优化"><a href="#多线程、算法及数据结构优化" class="headerlink" title="多线程、算法及数据结构优化"></a>多线程、算法及数据结构优化</h3><p>在确定了需要进行性能改善的代码后，一个最根本的优化方式是在程序设计层面进行改良。在移动客户端，对于影响了 UI 流畅度的代码，我们可以将其放到后台线程进行运行。Grand Central Dispatch (GCD) 或者 <code>NSOperation</code> 可以让我们方便地在不同线程中切换，而不太需要去担心线程调度的问题。一个使用 GCD 将繁重工作放到后台线程，然后在完成后回到主线程操作 UI 的典型例子是这样的：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> queue <span class="operator">=</span> dispatch_get_global_queue(<span class="type">QOS_CLASS_DEFAULT</span>, <span class="number">0</span>)</span><br><span class="line">    dispatch_async(queue) &#123;</span><br><span class="line">        <span class="comment">// 运行时间较长的代码，放到后台线程运行</span></span><br><span class="line">        dispatch_async(dispatch_get_main_queue()) &#123;</span><br><span class="line">            <span class="comment">// 结束后返回主线程操作 UI</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将工作放到其他线程虽然可以避免主线程阻塞，但它并不能减少这些代码实际的执行时间。进一步地，我们可以考虑改进算法和使用的数据结构来提高效率。根据实际项目中遇到的问题的不同，我们会有不同的解决方式，在这篇文章中，我们难以覆盖和深入去分析各种情况，所以这里我们只会提及一些共通的原则。</p>
<p>对于重复的工作，合理地利用缓存的方式可以极大提高效率，这是在优化时可以优先考虑的方式。Cocoa 开发中 <code>NSCache</code> 是专门用来管理缓存的一个类，合理地使用和配置 <code>NSCache</code> 把开发者中从管理缓存存储和失效的工作中解放出来。关于 <code>NSCache</code> 的详细使用方法，可以参看 <code>NSHipster</code> 关于这方面的<a target="_blank" rel="noopener" href="http://nshipster.com/nscache/">文章</a>以及 Apple 的<a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/NSCache_Class/">相关文档</a>。</p>
<p>在程序开发时，数据结构使用上的选择也是重要的一环。Swift 标准库提供了一些很基本的数据结构，比如 <code>Array</code>、<code>Dictionary</code> 和 <code>Set</code> 等。这些数据结构都是配合泛型的，在保证数据类型安全的同时，一般来说也能为我们提供足够的性能。关于这些数据的容器类型方法所对应的复杂度，Apple 都在标准库的文档或者注释中进行了标记。如果标准库所提供的类型和方法无法满足性能上的要求，或者没有符合业务需求的数据结构的话，那么考虑使用自己实现的数据结构也是可选项。</p>
<p>如果项目中有很多数学计算方面的工作导致了效率问题的话，考虑并行计算能极大改善程序性能。iOS 和 OS X 都有针对数学或者图形计算等数字信号处理方面进行了专门优化的框架：<a target="_blank" rel="noopener" href="https://developer.apple.com/library/tvos/documentation/Accelerate/Reference/AccelerateFWRef/index.html">Accelerate.framework</a>，利用相关的 API，我们可以轻松快速地完成很多经典的数字或者图像处理问题。因为这个框架只提供一组 C API，所以在 Swift 中直接使用会有一定困难。如果你的项目中要处理的计算相对简单的话，也可以使用 <a target="_blank" rel="noopener" href="https://github.com/mattt/Surge">Surge</a>，它是一个基于 Accelerate 框架的 Swift 项目，让我们能在代码里从并行计算中获得难以置信的性能提升。</p>
<h3 id="编译器优化"><a href="#编译器优化" class="headerlink" title="编译器优化"></a>编译器优化</h3><p>Swift 编译器十分智能，它能在编译期间帮助我们移除不需要的代码，或者将某些方法进行内联 (inline) 处理。编译器优化的强度可以在编译时通过参数进行控制，Xcode 工程默认情况下有 Debug 和 Release 两种编译配置，在 Debug 模式下，LLVM Code Generation 和 Swift Code Generation 都不开启优化，这能保证编译速度。而在 Release 模式下，LLVM 默认使用 “Fastest, Smallest [-Os]”，Swift Compiler 默认使用 “Fast [-O]”，作为优化级别。我们另外还有几个额外的优化级别可以选择，优化级别越高，编译器对于源码的改动幅度和开启的优化力度也就越大，同时编译期间消耗的时间也就越多。虽然绝大部分情况下没有问题，但是仍然需要当心的是，一些优化等级采用的是激进的优化策略，而禁用了一些检查。这可能在源码很复杂的情况下导致潜在的错误。如果你使用了很高的优化级别，请再三测试 Release 和 Debug 条件下程序运行的逻辑，以防止编译器优化所带来的问题。</p>
<p>值得一提的是，Swift 编译器有一个很有用的优化等级：”Fast, Whole Module Optimization”，也即 <code>-O -whole-module-optimization</code>。在这个优化等级下，Swift 编译器将会同时考虑整个 module 中所有源码的情况，并将那些没有被继承和重载的类型和方法标记为 <code>final</code>，这将尽可能地避免动态派发的调用，或者甚至将方法进行内联处理以加速运行。开启这个额外的优化将会大幅增加编译时间，所以应该只在应用要发布的时候打开这个选项。</p>
<p>虽然现在编译器在进行优化的时候已经足够智能了，但是在面对编写得非常复杂的情况时，很多本应实施的优化可能失效。因此保持代码的整洁、干净和简单，可以让编译器优化良好工作，以得到高效的机器码。</p>
<h3 id="尽量使用-Swift-类型"><a href="#尽量使用-Swift-类型" class="headerlink" title="尽量使用 Swift 类型"></a>尽量使用 Swift 类型</h3><p>为了和 Objective-C 协同工作，很多 Swift 标准库类型和对应的 Cocoa 类型是可以隐式的类型转换的，比如 <code>Swift.Array</code> 与 <code>NSArray</code>，<code>Swift.String</code> 和 <code>NSString</code> 等。虽然我们不需要在语言层面做类型转换，但是这个过程却不是免费的。在转换次数很多的时候，这往往会成为性能的瓶颈。一个常见的 Swift 和 Objective-C 混用的例子是 JSON 解析。考虑以下代码：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> jsonData: <span class="type">NSData</span> <span class="operator">=</span> <span class="comment">//...</span></span><br><span class="line"><span class="keyword">let</span> jsonObject <span class="operator">=</span> <span class="keyword">try?</span> <span class="type">NSJSONSerialization</span></span><br><span class="line">        .<span class="type">JSONObjectWithData</span>(jsonData, options: []) <span class="keyword">as?</span> [<span class="type">String</span>: <span class="type">AnyObject</span>]</span><br></pre></td></tr></table></figure>

<p>这是我们日常开发中很常见的代码，使用 <code>NSJSONSerialization</code> 将数据转换为 JSON 对象后，我们得到的是一个 NSObject 对象。在 Swift 中使用时，我们一般会先将其转换为 <code>[String: AnyObject]</code>，这个转换在一次性处理成千上万条 JSON 数据时会带来严重的性能退化。Swift 3 中我们可能可以基于 Swift 的 Foundation 框架来解决这个问题，但是现在，如果存在这样的情况，一种处理方式是避免使用 Swift 的字典类型，而使用 <code>NSDictionary</code>。另外，适当地使用 lazy 加载的方法，也是避免一次性进行过多的类型转换的好思路。</p>
<p>尽可能避免混合地使用 Swift 类型和 <code>NSObject</code> 子类，会对性能的提高有所帮助。</p>
<h3 id="避免无意义的-log，保持好的编码习惯"><a href="#避免无意义的-log，保持好的编码习惯" class="headerlink" title="避免无意义的 log，保持好的编码习惯"></a>避免无意义的 log，保持好的编码习惯</h3><p>在调试程序时，很多开发者喜欢用输出 log 的方式对代码的运行进行追踪，帮助理解。Swift 编译器并不会帮我们将 <code>print</code> 或者 <code>debugPrint</code> 删去，在最终 app 中它们会把内容输出到终端，造成性能的损失。我们当然可以在发布时用查找的方式将所有这些 log 输出语句删除或者注释掉，但是更好的方法是通过添加条件编译来将这些语句排除在 Release 版本外。在 Xcode 的 Build Setting 中，在 Other Swift flags 的 Debug 栏中加入 <code>-D DEBUG</code> 即可加入一个编译标识。</p>
<p>之后我们就可以通过将 <code>print</code> 或者 <code>debugPrint</code> 包装一下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">dPrint</span>(<span class="params">item</span>: <span class="keyword">Any</span>) &#123;</span><br><span class="line">    <span class="keyword">#if</span> <span class="type">DEBUG</span></span><br><span class="line">    <span class="built_in">print</span>(item)</span><br><span class="line">    <span class="keyword">#endif</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，在 Release 版本中，<code>dPrint</code> 将会是一个空方法，所有对这个方法的调用都会被编译器剔除掉。需要注意的是，在这种封装下，如果你传入的 <code>items</code> 是一个表达式而不是直接的变量的话，这个表达式还是会被先执行求值的。如果这对性能也产生了可测的影响的话，我们最好用 <code>@autoclosure</code> 修饰参数来重新包装 <code>print</code>。这可以将求值运行推迟到方法内部，这样在 Release 时这个求值也会被一并去掉：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> <span class="title function_">dPrint</span>(<span class="keyword">@autoclosure</span> <span class="params">item</span>: () -&gt; <span class="keyword">Any</span>) &#123;</span><br><span class="line">    <span class="keyword">#if</span> <span class="type">DEBUG</span></span><br><span class="line">    <span class="built_in">print</span>(item())</span><br><span class="line">    <span class="keyword">#endif</span></span><br><span class="line">&#125;</span><br><span class="line">dPrint(resultFromHeavyWork())</span><br><span class="line"><span class="comment">// Release 版本中 resultFromHeavyWork() 不会被执行</span></span><br></pre></td></tr></table></figure>

<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>Swift 还是一门很新的语言，并且处于高速发展中。因为现在 Swift 只用于 Cocoa 开发，因此它和 Cocoa 框架还有着千丝万缕的联系。很多时候由于这些原因，我们对于 Swift 性能的评估并不公正。这门语言本身设计就是以高性能为考量的，而随着 Swift 的开源和进一步的进化，以及配套框架的全面重写，相信在语言层面上我们能获得更好的性能和编译器的支持。</p>
<p>最好的优化就是不用优化。在软件开发中，保证书写正确简洁的代码，在项目开始阶段就注意可能存在的性能缺陷，将可扩展性的考虑纳入软件构建中，按照实际需求进行优化，不要陷入为了优化而优化的怪圈，这些往往都可以让我们避免额外的优化时间，让我们的工作得更加愉快。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="http://llvm.org/devmtg/2015-10/slides/GroffLattner-SILHighLevelIR.pdf">Swift Intermediate Language</a></li>
<li><a target="_blank" rel="noopener" href="http://nshipster.com/nscache/">NSCache - NSHipster</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/NSCache_Class/">NSCache 文档</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/mattt/Surge">Surge</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/12/21/swfitService/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/21/swfitService/" class="post-title-link" itemprop="url">使用 Swift 搭建服务器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-21 11:04:00" itemprop="dateCreated datePublished" datetime="2016-12-21T11:04:00+08:00">2016-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 20:51:45" itemprop="dateModified" datetime="2023-12-21T20:51:45+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="http://www.cocoachina.com/swift/20160318/15712.html">原文地址</a></p>
<p>自从苹果官方发布了一个 Swift 的 Linux 开源版本之后，服务端 Swift 终于迎来了一个令人激动的前景。我的好奇心终于无法克制，是时候尝试一下服务端 Swift 了！</p>
<p>除了用过几个 Baas 以外，我没有任何后端编程经验，但幸运的是开源社区已经提供了现成的框架。我试了一下 <a target="_blank" rel="noopener" href="https://twitter.com/tanner0101">Tanner Nelson</a> 推荐的 <a target="_blank" rel="noopener" href="https://github.com/qutheory/vapor">Vapor</a> 框架。它的使用非常简单，非常适合我当前的任务，在这篇文档中还会使用到 Heroku。我决定使用 Heroku 的原因是我们的后端团队在使用它，它对于前端来说非常友好。</p>
<p>写到这里的时候，为了解决 Heroku 框架运行中的几个小问题，我专门提交了一个 <a target="_blank" rel="noopener" href="https://github.com/qutheory/vapor/pull/25">pull request</a> 。如果代码还没被合并的话，请设置你的包管理器从 <a target="_blank" rel="noopener" href="https://github.com/loganwright/vapor">这里</a> 下载。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>要继续本教程，首先，你需要一个 <a target="_blank" rel="noopener" href="https://signup.heroku.com/?c=70130000001x9jFAAQ">Heroku</a> 账号 ，并安装好 <a target="_blank" rel="noopener" href="https://swift.org/download/">Swift Development Snapshot</a> 。写到这里的时候，在它的正式版中还未包含 swift 包管理器。因此为了使用这个工具，你必须下载开发版的 snapshot。</p>
<h4 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h4><p>我们的目标是创建一个简单的 Swift 服务器并运行在 Heroku 上。这不需要在 linux 环境下进行，就像是你在使用本地服务器。你只消创建一个本地的 Xcode 项目，对项目进行一些设置，然后就可以在 <a target="_blank" rel="noopener" href="https://swift.org/package-manager/">Swift 包管理器</a> 中运行它。整过过程分为 4 个步骤：</p>
<p>####### 将 main.swift 拷贝根目录下的 Sources 目录</p>
<p><a href = "/img/swfitService/swiftService1.png"><img src = "/img/swfitService/swiftService1.png" width = 720 height = 598 alt = "swiftService1.png"/></a></p>
<p>####### 创建一个 Package.swift 文件</p>
<p><a href = "/img/swfitService/swiftService2.png"><img src = "/img/swfitService/swiftService2.png" width = 720 height = 218 alt = "swiftService2.png"/></a></p>
<p>####### 将 .build 目录添加到 import paths </p>
<p>要使用自动补全和语法加亮功能，需要将 Swift 包管理器的 build 目录提交到 import paths 中。注意，在 import paths 的 Debug 中设置的 debug 目录，而 Release 项则输入 release 目录。</p>
<p><a href = "/img/swfitService/swiftService3.png"><img src = "/img/swfitService/swiftService3.png" width = 720 height = 334 alt = "swiftService3.png"/></a></p>
<p>####### 用 toolchain 运行 Xcode</p>
<p>如果你使用 Xcode 7.3，你可以用 Xcode &gt; Toolchains 菜单开启一个Xcode 实例，用于打开 swift snapshot。因为我们不能在 Xcode 中进行编译，我们只能以命令行的方式进行编译。</p>
<p><a href = "/img/swfitService/swiftServie4.png"><img src = "/img/swfitService/swiftService4.png" width = 594 height = 16 alt = "swiftService4.png"/></a></p>
<h4 id="编写服务器"><a href="#编写服务器" class="headerlink" title="编写服务器"></a>编写服务器</h4><p>令我高兴的是，为了进行概念验证，我需要编写的代码其实只有寥寥数行。我启动和运行服务器的代码甚至不到 10 行。</p>
<p><a href = "/img/swfitService/swiftServie5.png"><img src = "/img/swfitService/swiftService5.png" width = 720 height = 239 alt = "swiftService5.png"/></a></p>
<p>要启动服务器，只需在终端中输入一句命令，：</p>
<p><a href = "/img/swfitService/swiftService6.png"><img src = "/img/swfitService/swiftService6.png" width = 720 height = 126 alt = "swiftService6.png"/></a></p>
<p>好了，让我们打开浏览器。我的浏览器安装了 json 插件，你的画面或许会有不同。</p>
<p><a href = "/img/swfitService/swiftService7.png"><img src = "/img/swfitService/swiftService7.png" width = 556 height = 240 alt = "swiftService7.png"/></a></p>
<h4 id="迁移到云上"><a href="#迁移到云上" class="headerlink" title="迁移到云上"></a>迁移到云上</h4><p>服务器在本地顺利运行起来了，但如果放到云端则更好。我迫不及待地想将 App 在云上跑起来。对于我来说这是一个全新的挑战，幸运的是，我得到了 <a target="_blank" rel="noopener" href="https://twitter.com/vincenttoms">Vincent Toms</a> 的悉心指导。</p>
<p>Heroku 的安装是一件非常愉悦的体验，几分钟后我就创建了一个 Heroku App，接下来我就要上传我的项目了。</p>
<p>####### 出错啦</p>
<p>这只是今天的诸多错误中的一个。我已经预计到事情不可能一帆风顺，因此我查看了 Vapor 的文档，最终发现问题出在所谓的 <a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/buildpacks">buildpacks</a> 上。Heorku 提供了一些标准的 buildpacks，但完全没有针对 Swift 的 buildpacks。无奈之下求救于开源社区，刚好看到 Kyle Fuller 的 <a target="_blank" rel="noopener" href="https://github.com/kylef/heroku-buildpack-swift">buildpack</a> 。集成它就简单得多了。</p>
<p><a href = "/img/swfitService/swiftService8.png"><img src = "/img/swfitService/swiftService8.png" width = 720 height = 85 alt = "swiftService8.png"/></a></p>
<p>用这个 buildpack 启动后，App 成功加载，接下来就是访问它的 URL。</p>
<p>####### 再次出错</p>
<p><a href = "/img/swfitService/swiftService9.png"><img src = "/img/swfitService/swiftService9.png" width = 720 height = 147 alt = "swiftService9.png"/></a></p>
<p>事情不会那么顺利的，是吧？经过 google 一番，仔细查看了一些例子，我发现我还差一个 Procfile。浏览一下这个文件的内容，你就能明白这个文件是干什么用的了。</p>
<p><a href = "/img/swfitService/swiftService10.png"><img src = "/img/swfitService/swiftService10.png" width = 664 height = 170 alt = "swiftService10.png"/></a></p>
<p>buildpack 创建了可执行文件，但 Heroku 并不知道。通过 Procfile，我们告诉 Heroku 去运行 SwiftServerIO 可执行文件。上传这个 Procfile。</p>
<p>####### 仍然出错</p>
<p>Heroku 编译的 2 分支仿佛变得无比漫长。我重新打开了浏览器，发现仍然报错。</p>
<p><a href = "/img/swfitService/swiftService11.png"><img src = "/img/swfitService/swiftService11.png" width = 720 height = 153 alt = "swiftService11.png"/></a></p>
<p>我以为 Heroku 可能还未启动完成（实际不是），因此我又等了一小会，终于发现出错了。可执行文件生成了， process file 也就绪，一定是别的什么地方出问题了。再次 google，一直到我最终发现我需要设置 App 的规模(<a target="_blank" rel="noopener" href="https://devcenter.heroku.com/articles/scaling#cli">scale up</a>)。这要使用到 Heroku 的 toolbelt 中的一个简单命令。</p>
<p>heroku ps:scale web&#x3D;1</p>
<p>Heroku 在免费情况下只有一个 dyno（Heroku 计费单位，10~50 个请求&#x2F;秒）。但对于我们的简单服务器来说，这也够了。因此，在我们将 scale web 设置为 1 个 dyno 之后，再次用浏览器查看。</p>
<p>成功了！</p>
<p><a href = "/img/swfitService/swiftService13.png"><img src = "/img/swfitService/swiftService13.png" width = 168 height = 166 alt = "swiftService13.png" /></a></p>
<p>成功了！服务器启动，出现了万能的 hello world！经过一番欢呼雀跃之后，让我们真正来问一声好吧！</p>
<p>####### 响应请求</p>
<p>在 main.swfit 文件中添加一小段代码，让服务器在问好的同时能够因人而异。就微微偷一下懒，新加一个路由，让服务器根据输入输出不同的问候语。</p>
<p><a href = "/img/swfitService/swiftService14.png"><img src = "/img/swfitService/swiftService14.png" width = 720 height = 296 alt = "swiftService14.png" /></a></p>
<p>一切正常，但根据一般规律，我仍然做好了出错的心理准备。提交修改，push 代码到 Heroku。</p>
<p>####### Say Hello!</p>
<p><a href = "/img/swfitService/swiftService15.png"><img src = "/img/swfitService/swiftService15.png" width = 413 height = 151 alt = "swiftService15.png" /></a></p>
<p>大约一份多钟的编译之后，在浏览器中访问 URL，服务器返回了问候语。<a target="_blank" rel="noopener" href="http://swift-server-io.herokuapp.com/hello/reader">你可以在这里查看效果</a> 。</p>
<p>接下来是什么？</p>
<p>可以说，服务端 Swift 的今天离不开社区强大支持。对于我来说，能够从云端获取 JSON 是一个令人兴奋的开始，我已经迫不及待地想看看接下来还会发生什么。</p>
<p>当然在此之前，我不得不和我在 <a target="_blank" rel="noopener" href="http://intrepid.io/">Intrepid Pursuits</a> 的同事们一起，继续编写一个有一个 iOS App。如果你想了解我的最新动态，请在访问我的 <a target="_blank" rel="noopener" href="https://github.com/loganwright">Github</a> 或者 <a target="_blank" rel="noopener" href="https://twitter.com/logmaestro">Twitter</a>。</p>
<p><a target="_blank" rel="noopener" href="http://www.swiftserver.io/hello/server-side-swift">服务端 Swift</a> </p>
<p>附言</p>
<p>在 <a target="_blank" rel="noopener" href="https://github.com/loganwright/vapor">这里</a> 下载源代码。</p>
<p>在 <a target="_blank" rel="noopener" href="https://github.com/LoganWright/swift-server-io/tree/master/Journal">Journal</a> 文件夹中，是 step-by-step 指南。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">qxy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">24</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qxy</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
