<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="一艘小船">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="一艘小船">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="qxy">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>一艘小船</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">一艘小船</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">说翻就翻</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/12/1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/12/1/" class="post-title-link" itemprop="url">加载大量试图的优化策略</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-04-12 15:32:00" itemprop="dateCreated datePublished" datetime="2023-04-12T15:32:00+08:00">2023-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-25 14:41:40" itemprop="dateModified" datetime="2023-12-25T14:41:40+08:00">2023-12-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在项目的实际运行中，发现有用户创建了大量视图，多达4000多，在进入项目的时候一次性创建不仅会消耗大量内存，还会卡顿，所以需要对这部分进行优化。</p>
<p>优化的方向分为</p>
<p>###1、 加载策略优化</p>
<p>项目中的视图并不是同时全部可见的，有很多初始状态是隐藏，所以在加载的时候遇到是隐藏状态的，全部加入延时队列，</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/05/12/POPUseRequest/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/12/POPUseRequest/" class="post-title-link" itemprop="url">面向协议的网络库业务封装</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-12 15:32:00" itemprop="dateCreated datePublished" datetime="2022-05-12T15:32:00+08:00">2022-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-25 20:45:11" itemprop="dateModified" datetime="2023-12-25T20:45:11+08:00">2023-12-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>项目中使用的网络库为 <code>Alamofire</code> ，数据映射库为 <code>ObjectMapper</code> ，由于项目中存在的网络库使用不够友好，维护扩展新的接口比较繁琐，所以抽空重写了一个网络库的封装</p>
<h3 id="基本框架方案的选择"><a href="#基本框架方案的选择" class="headerlink" title="基本框架方案的选择"></a>基本框架方案的选择</h3><p> 旧的网络库框架使用了单例与扩展的模式，在使用中的形式为 <code>API.requestA</code> 、<code>API.requestA</code> 的形式，随着接口的增多，<code>API</code> 类下的方法日益增多，显得一团乱。所以接口的调用形式改为 <code>Protocol</code> ，哪里使用哪个模块的接口，就遵循对应模块的 API 协议，不再暴露所有API接口在整个项目中。</p>
<p> 一般在业务调用接口的时候，希望处理数据的地方也是在当前位置（当然异步的回调放哪里都一样），这样的代码在后续的维护中更好找到业务逻辑，所以回调统一使用闭包，放弃 <code>Target Select</code> 模式。</p>
<h3 id="基础请求-protocol-的创建"><a href="#基础请求-protocol-的创建" class="headerlink" title="基础请求 protocol 的创建"></a>基础请求 protocol 的创建</h3><p> 我们以最基础的 HTTP 请求举例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protocol API &#123;</span><br><span class="line">    func request()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由于这是总的请求入口，那么需要传入各个请求需要使用的参数，这些又是跟业务相关的东西，那么应该封装在一起，这里传入的参数，只需要能获取到对应需要的各个值，不限定传入的参数类型，那么请求参数也设计成一个 <code>Protocol</code> </p>
<p>然后超时时间，对于这个参数，可能同一个接口在不同位置所需的时间会不一致，所以作为一个保留参数，提供默认值（由于协议的声明不是设置默认值，所以放在 <code>extension</code> 中），现在代码看起来是这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">protocol API &#123;</span><br><span class="line">    func request(config: ApiConfigProtocol, timeoutInterval: TimeInterval)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还需要集成数据映射，在请求返回数据初步处理之后，那么还需要一个泛型，因为映射的方法也属于一个协议，所以我们需要泛型遵循此协议，请求返回的闭包，参考 <code>Alamofire</code> 的方式，也以返回一个对象的形式来实现串行闭包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protocol API &#123;</span><br><span class="line">    func request&lt;T: APIMappable&gt;(</span><br><span class="line">        config: ApiConfigProtocol,</span><br><span class="line">        timeoutInterval: TimeInterval) -&gt; Response&lt;T&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在所有请求需要和返回的要素有了，我们开始构建</p>
<h3 id="构建-APIMappable"><a href="#构建-APIMappable" class="headerlink" title="构建 APIMappable"></a>构建 <code>APIMappable</code></h3><p>这里我们自定义一个 <code>protocol</code>，基于 <code>ObjectMapper</code> 的 <code>BaseMappable</code> 协议</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">protocol APIMappable: BaseMappable &#123;</span><br><span class="line">    init?(json: Any?)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extension APIMappable &#123;</span><br><span class="line">    public init?(map: Map) &#123; self.init(json: nil) &#125;</span><br><span class="line">    </span><br><span class="line">    init?(json: Any?) &#123;</span><br><span class="line">        guard let JSON = json as? [String: Any],</span><br><span class="line">           let obj: Self = Mapper().map(JSON: JSON) else &#123;</span><br><span class="line">            return nil</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        self = obj</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extension Array: APIMappable, BaseMappable where Element: BaseMappable &#123;</span><br><span class="line">    public mutating func mapping(map: ObjectMapper.Map) &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    init?(json: Any?) &#123;</span><br><span class="line">        if let JSONArray = json as? [[String: Any]] &#123;</span><br><span class="line">            let obj: [Element] = Mapper(context: nil).mapArray(JSONArray: JSONArray)</span><br><span class="line">            self = obj</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return nil</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="构建-ApiConfigProtocol"><a href="#构建-ApiConfigProtocol" class="headerlink" title="构建 ApiConfigProtocol"></a>构建 <code>ApiConfigProtocol</code></h3><p>域名与header一般来说比较固定，就直接在<code>extension</code>中返回默认值，它看起来像这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">protocol ApiConfigProtocol &#123;</span><br><span class="line">    /// 域名</span><br><span class="line">    var domain: String &#123;get&#125;</span><br><span class="line">    /// 路径</span><br><span class="line">    var path: String &#123;get&#125;</span><br><span class="line">    /// 请求方法</span><br><span class="line">    var method: HTTPMethod &#123;get&#125;</span><br><span class="line">    /// 请求头</span><br><span class="line">    var header: HTTPHeaders &#123; get &#125;</span><br><span class="line">    /// 请求参数</span><br><span class="line">    var parameters: [String: Any]? &#123; get &#125;</span><br><span class="line">    /// 参数编码</span><br><span class="line">    var encoder: ParameterEncoding &#123;get&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extension ApiConfigProtocol &#123;</span><br><span class="line">    var domain: String &#123; &quot;https://xxxx.com&quot; &#125;</span><br><span class="line">    var header: HTTPHeaders &#123; defaultHeader() &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    func defaultHeader() -&gt; HTTPHeaders &#123;</span><br><span class="line">        var dic = [String: String]()</span><br><span class="line">        dic[&quot;token&quot;] = &quot;xxxx&quot;</span><br><span class="line">        return HTTPHeaders.init(dic)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在实际使用中，对应的业务模块实现该协议，例如一个与服务系统相关的模块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">enum APISystemConfig: ApiConfigProtocol &#123;</span><br><span class="line">    case sysTime</span><br><span class="line">    case sysVersion</span><br><span class="line">    </span><br><span class="line">    var path: String &#123;</span><br><span class="line">        switch self &#123;</span><br><span class="line">        case .sysTime: return &quot;/sysTime&quot;</span><br><span class="line">        case .sysVersion: return &quot;/sysVersion&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var header: HTTPHeaders &#123;</span><br><span class="line">        var defaultHeader = defaultHeader()</span><br><span class="line">        </span><br><span class="line">        switch self &#123;</span><br><span class="line">        case .sysTime:  return defaultHeader</span><br><span class="line">        case .sysVersion:</span><br><span class="line">            defaultHeader.add(name: &quot;platform&quot;, value: &quot;ios&quot;)</span><br><span class="line">            return defaultHeader</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var method: HTTPMethod &#123;</span><br><span class="line">        switch self &#123;</span><br><span class="line">        case .sysTime: return .get</span><br><span class="line">        case .sysVersion: return .post</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    var parameters: [String : Any]? &#123;</span><br><span class="line">        switch self &#123;</span><br><span class="line">        case .sysTime: return [:]</span><br><span class="line">        case .sysVersion: return [&quot;appVersion&quot;: &quot;1.0.0&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    var encoder: ParameterEncoding &#123;</span><br><span class="line">        switch self &#123;</span><br><span class="line">        case .sysTime, .sysVersion: return JSONEncoding.default</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="构建-Response"><a href="#构建-Response" class="headerlink" title="构建 Response"></a>构建 Response</h3><p>此类需要管理众多闭包，以便于接口返回后的处理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">class Response&lt;T: APIMappable&gt; &#123;</span><br><span class="line">    init() &#123;&#125;</span><br><span class="line">    weak var request: DataRequest?</span><br><span class="line">    func cancel() &#123;</span><br><span class="line">        request?.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    typealias modelBlock = (T) -&gt; Void</span><br><span class="line">    typealias errorBlock = (APIError) -&gt; Void</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    private var modelBlocks = [modelBlock?]()</span><br><span class="line">    private var errorBlocks = [errorBlock?]()</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    fileprivate func handleModel(_ model: T) &#123;</span><br><span class="line">        modelBlocks.forEach &#123;$0?(model)&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    fileprivate func handleError(_ error: APIError) &#123;</span><br><span class="line">        errorBlocks.forEach &#123;$0?(error)&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    @discardableResult</span><br><span class="line">    func model(_ completionHandler: modelBlock?) -&gt; Self &#123;</span><br><span class="line">        modelBlocks.append(completionHandler)</span><br><span class="line">        return self</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">    @discardableResult</span><br><span class="line">    func error(_ completionHandler: errorBlock?) -&gt; Self &#123;</span><br><span class="line">        errorBlocks.append(completionHandler)</span><br><span class="line">        return self</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="搭建Model框架"><a href="#搭建Model框架" class="headerlink" title="搭建Model框架"></a>搭建Model框架</h3><p>假如我们的服务器数据为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;code&quot;: 200,</span><br><span class="line">    &quot;message&quot;: &quot;no message&quot;,</span><br><span class="line">    &quot;data&quot;: &#123;</span><br><span class="line">        &quot;time&quot;: 2942798372937</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>data</code>是我们想要的业务数据，<code>code</code> 和 <code>message</code> 是用来处理接口的返回逻辑的，我们的 Response Model为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">class ResponseModel: APIMappable &#123;</span><br><span class="line">    var code = 0</span><br><span class="line">    var message = &quot;&quot;</span><br><span class="line">    var data: Any? = nil</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    func mapping(map: ObjectMapper.Map) &#123;</span><br><span class="line">        code &lt;- map[&quot;code&quot;]</span><br><span class="line">        message &lt;- map[&quot;message&quot;]</span><br><span class="line">        data &lt;- map[&quot;data&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class SysTimeModel: APIMappable &#123;</span><br><span class="line">    var time: TimeInterval = 0</span><br><span class="line">    func mapping(map: ObjectMapper.Map) &#123;</span><br><span class="line">        time &lt;- map[&quot;time&quot;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现请求逻辑"><a href="#实现请求逻辑" class="headerlink" title="实现请求逻辑"></a>实现请求逻辑</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">extension API &#123;</span><br><span class="line">    func request&lt;T: APIMappable&gt;(</span><br><span class="line">        config: ApiConfigProtocol,</span><br><span class="line">        timeoutInterval: TimeInterval = 20) -&gt; Response&lt;T&gt; &#123;</span><br><span class="line">            let result = Response&lt;T&gt;()</span><br><span class="line">            </span><br><span class="line">            let request = AF.request(config.domain + config.path,</span><br><span class="line">                                     method: config.method,</span><br><span class="line">                                     parameters: config.parameters,</span><br><span class="line">                                     encoding: config.encoder,</span><br><span class="line">                                     headers: config.header</span><br><span class="line">            ) &#123;$0.timeoutInterval = timeoutInterval&#125;</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">            request.responseData &#123; res in</span><br><span class="line">                switch res.result &#123;</span><br><span class="line">                case .success(let data):</span><br><span class="line">                    if let JSON = try? JSONSerialization.jsonObject(with: data, options: JSONSerialization.ReadingOptions.allowFragments),</span><br><span class="line">                       let model = ResponseModel(json: JSON) &#123;</span><br><span class="line">                        </span><br><span class="line">                        switch model.code &#123;</span><br><span class="line">                        case 200:</span><br><span class="line">                            if let model = T.init(json: JSON) &#123;</span><br><span class="line">                                result.handleModel(model)</span><br><span class="line">                            &#125; else &#123;</span><br><span class="line">                                result.handleError(APIError(message: &quot;解析错误 \(model.message)&quot;))</span><br><span class="line">                            &#125;</span><br><span class="line">                        case 401:</span><br><span class="line">                            print(&quot;token失效&quot;)</span><br><span class="line">                            // loginOut()</span><br><span class="line">                        default:</span><br><span class="line">                            result.handleError(APIError(message: &quot;未知错误 \(model.message)&quot;))</span><br><span class="line">                        &#125;</span><br><span class="line">                        </span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        result.handleError(APIError(message: &quot;JSON解析错误&quot;))</span><br><span class="line">                    &#125;</span><br><span class="line">                    </span><br><span class="line">                case .failure(let error):</span><br><span class="line">                    result.handleError(APIError(message: error.localizedDescription))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            result.request = request</span><br><span class="line">            </span><br><span class="line">            return result</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="封装业务"><a href="#封装业务" class="headerlink" title="封装业务"></a>封装业务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">protocol SystemAPI: API &#123;&#125;</span><br><span class="line">extension SystemAPI &#123;</span><br><span class="line">    func getSysTime() -&gt; Response&lt;ResponseModel&gt; &#123;</span><br><span class="line">        return request(config: APISystemConfig.sysTime)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func getSysVersion() -&gt; Response&lt;[ResponseModel]&gt; &#123;</span><br><span class="line">        return request(config: APISystemConfig.sysVersion)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">extension ViewController: SystemAPI &#123;</span><br><span class="line">    func getData() &#123;</span><br><span class="line">        </span><br><span class="line">        getSysTime()</span><br><span class="line">            .model &#123; model in</span><br><span class="line">                print(&quot;model&quot;, model.time)</span><br><span class="line">            &#125;</span><br><span class="line">            .model &#123; model in</span><br><span class="line">                print(&quot;this model is&quot;, model)</span><br><span class="line">            &#125;</span><br><span class="line">            .error &#123; err in</span><br><span class="line">                print(&quot;err&quot;, err.message)</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        let getSysVersionTask = getSysVersion()</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line">        getSysVersionTask.model &#123; list in</span><br><span class="line">            list.forEach &#123;print(&quot;list model _&quot;, $0.time)&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        getSysVersionTask.error &#123; err in</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        getSysVersionTask.cancel()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/10/23/POP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/10/23/POP/" class="post-title-link" itemprop="url">面向协议编程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-10-23 20:54:00" itemprop="dateCreated datePublished" datetime="2017-10-23T20:54:00+08:00">2017-10-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>面向协议编程 (Protocol Oriented Programming，以下简称 POP) 是 Apple 在 2015 年 WWDC 上提出的 Swift 的一种编程范式。相比与传统的面向对象编程  OOP，POP 显得更加灵活。</p>
<p>Swift 的标准库使用了大量的协议，整个iOS&#x2F;MacOS库使用了大量协议来搭建框架。</p>
<h3 id="面向对象的特点"><a href="#面向对象的特点" class="headerlink" title="面向对象的特点"></a>面向对象的特点</h3><p>构建一个模块的框架，在面向对象中会抽取出公共父类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">class Person &#123;</span><br><span class="line">    var age = 0</span><br><span class="line">    var name = &quot;&quot;</span><br><span class="line">    </span><br><span class="line">    func sayName() &#123;</span><br><span class="line">        print(&quot;my age is \(name)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func eat() &#123;</span><br><span class="line">        print(&quot;eat food.&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Student: Person &#123;</span><br><span class="line">    override func eat() &#123;</span><br><span class="line">        print(&quot;eat Person meal&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Teacher: Person &#123;</span><br><span class="line">    var salary = 0.0</span><br><span class="line">    </span><br><span class="line">    override func eat() &#123;</span><br><span class="line">        print(&quot;eat Teacher meal&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func getPaid() &#123;</span><br><span class="line">        print(&quot;this month get paid: \(salary)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以看到父类持有共同的属性与方法，子类可以自由决定是否重写，比如 <code>Person</code> 中的 <code>sayName</code> 方法，子类无需再次实现，只需要继承即可使用，增加代码的复用率。</p>
<p>我们还有一个属性 <code>salary</code> 薪资，以及领工资的行为，并不是所有人都有薪资以及领工资的行为，所以目前就单独放在 <code>Teacher</code> 中。</p>
<p>这个时候这个模块很完美，没有多余的代码，结构清晰。</p>
<p>接下来某一天新增一个需求，需要一个厨师，也有 <code>Person</code> 的所有特质，那么理所当然应该继承自 <code>Person</code> ：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Cook: Person &#123;</span><br><span class="line">    override func eat() &#123;</span><br><span class="line">        print(&quot;Cook eat&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    func Salary() &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是厨师也应该有薪资以及领工资行为，从<code>Teacher</code>复制一份到<code>Cook</code>显然不是我们想要的，如果放在<code>Person</code>里共用，又会超出<code>Person</code>应该承受的范围，会导致比如<code>Student</code>继承一些用不到的属性和方法，那么按照面向对象的思想，我们应该在<code>Teacher</code> 、<code>Cook</code> 与 <code>Person</code> 中间增加一层：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">class Workers: Person &#123;</span><br><span class="line">    var salary = 0.0</span><br><span class="line">    func getPaid() &#123;</span><br><span class="line">        print(&quot;this month get paid: \(salary)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Teacher: Workers &#123;</span><br><span class="line">    override func eat() &#123;</span><br><span class="line">        print(&quot;eat Teacher meal&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Cook: Workers &#123;</span><br><span class="line">    override func eat() &#123;</span><br><span class="line">        print(&quot;Cook eat&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样从 OOP 的思想上完美解决问题，但是这种改动会涉及到原先的继承框架，需要改动原来的继承关系，显然会增加不确定性与繁琐性，而且 Swift 中的继承只有单继承，所以如果完全靠 OOP 的范式去维护框架，只有这一条路。</p>
<h3 id="使用协议与扩展解决上诉问题"><a href="#使用协议与扩展解决上诉问题" class="headerlink" title="使用协议与扩展解决上诉问题"></a>使用协议与扩展解决上诉问题</h3><p>一个简单的协议与扩展：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">protocol PersonProtocol &#123;</span><br><span class="line">    var age: Int &#123;set get&#125;</span><br><span class="line">    var name: String &#123;set get&#125;</span><br><span class="line">    </span><br><span class="line">    func sayName()</span><br><span class="line">    func eat()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extension PersonProtocol &#123;</span><br><span class="line">    func sayName() &#123;</span><br><span class="line">        print(&quot;my age is \(name)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    func eat() &#123;</span><br><span class="line">        print(&quot;eat food.&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有遵循此协议的类都必须包含对应的属性与方法，协议扩展实现的方法，会变成可选方法，到这里就完全可以用 <code>PersonProtocol</code> 来代替 <code>Person</code>类，再用<code>WorkersProtocol</code>代替 <code>Workers</code>类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">protocol WorkersProtocol: PersonProtocol &#123;</span><br><span class="line">    var salary: Float &#123; set get &#125;</span><br><span class="line">    func getPaid()</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line">extension WorkersProtocol &#123;</span><br><span class="line">    func getPaid() &#123;</span><br><span class="line">        print(&quot;this month get paid: \(salary)&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在的三种类将会变成：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">class Student: PersonProtocol &#123;</span><br><span class="line">    var age: Int = 0</span><br><span class="line">    var name: String = &quot;&quot;</span><br><span class="line">    </span><br><span class="line">    func eat() &#123;</span><br><span class="line">        print(&quot;eat Person meal&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Teacher: WorkersProtocol &#123;</span><br><span class="line">    var age: Int = 0</span><br><span class="line">    var name: String = &quot;&quot;</span><br><span class="line">    var salary: Float = 0.0</span><br><span class="line">    </span><br><span class="line">    func eat() &#123;</span><br><span class="line">        print(&quot;eat Teacher meal&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Cook: WorkersProtocol &#123;</span><br><span class="line">    var age: Int = 0</span><br><span class="line">    var name: String = &quot;&quot;</span><br><span class="line">    var salary: Float = 0.0</span><br><span class="line">    </span><br><span class="line">    func eat() &#123;</span><br><span class="line">        print(&quot;Cook eat&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时候的类，只需要遵循自己需要的协议，就可以变相继承公共的属性和方法，脱离出 OOP 的框架，对框架的扩展与维护增加的极大的便利。</p>
<p>而且这个时候对于不同的继承系列里相同的特征，也可以用协议来实现代码的复用与框架的扩展合理性</p>
<p>当然并不是要完全抛弃 OOP，他们各有长处， 应该配合来使用。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/05/RN_6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/05/RN_6/" class="post-title-link" itemprop="url">React Native (六)：加载所有分类与详情页</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-05 16:12:00" itemprop="dateCreated datePublished" datetime="2017-05-05T16:12:00+08:00">2017-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:20:19" itemprop="dateModified" datetime="2023-12-21T21:20:19+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<h2 id="1-加载全部分类新闻"><a href="#1-加载全部分类新闻" class="headerlink" title="1.加载全部分类新闻"></a>1.加载全部分类新闻</h2><p>我们需要做的效果是打开 <code>App</code> ，首先只加载第一页的数据，其他页面在第一次显示的时候加载数据。</p>
<p>我们需要一个状态来标明是不是第一次显示，给 <code>state</code> 加入 <code>isFirstShow: true</code>，我们在网络请求里给他赋值为 <code>false</code>。</p>
<p>在做的过程中发现一个问题，我们需要取到它的 <code>EndKey</code> 来作为下次请求的 <code>StartKey</code> ，否则可能会请求失败，给 <code>state</code> 加入 <code>startKey: &#39;&#39;</code> ，然后在请求到数据后赋值：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title function_">_onRefresh</span>(<span class="params">page</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isFirstShow</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_begainRefresh</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (page == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                page</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span>  &#123;</span><br><span class="line">            page = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newspush/list/index.html?clientid=1114283782&amp;v=1.1&amp;type=&#x27;</span></span><br><span class="line">            + <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>.<span class="property">NameEN</span></span><br><span class="line">            + <span class="string">&#x27;&amp;startkey=&#x27;</span></span><br><span class="line">            + <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">startKey</span></span><br><span class="line">            +<span class="string">&#x27;&amp;newkey=&amp;index=&#x27;</span></span><br><span class="line">            + page</span><br><span class="line">            + <span class="string">&#x27;&amp;size=&#x27;</span></span><br><span class="line">            + maxCount</span><br><span class="line">            + <span class="string">&#x27;&amp;ime=6271F554-7B2F-45DE-887E-4A336F64DEE6&amp;apptypeid=ZJZYIOS1114283782&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">LOG</span>(<span class="string">&#x27;url=》&#x27;</span>, url)</span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_endRefresh</span>()</span><br><span class="line"></span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> list = json.<span class="property">NewsList</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> swipers = []</span><br><span class="line">                        <span class="keyword">let</span> news = []</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (page == <span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">                                <span class="keyword">let</span> dic = list[index]</span><br><span class="line">                                index &lt; <span class="number">4</span> ? swipers.<span class="title function_">push</span>(dic) : news.<span class="title function_">push</span>(dic)</span><br><span class="line">                            &#125;</span><br><span class="line">                            news.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">0</span>, swipers)</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            news = list</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> newData = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">data</span>.<span class="title function_">concat</span>(news)</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">let</span> hasMore = list.<span class="property">length</span> == maxCount ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                            <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(newData),</span><br><span class="line">                            <span class="attr">data</span>: newData,</span><br><span class="line">                            <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span> + (hasMore ? <span class="number">1</span> : <span class="number">0</span>),</span><br><span class="line">                            <span class="attr">showFooter</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span> ? <span class="literal">true</span> : (hasMore ? <span class="literal">true</span> : <span class="literal">false</span>),</span><br><span class="line">                            hasMore,</span><br><span class="line">                            <span class="attr">startKey</span>: json.<span class="property">EndKey</span> ? json.<span class="property">EndKey</span> : <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">startKey</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR then =&gt;&#x27;</span>, url, e)</span><br><span class="line"></span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_endRefresh</span>()</span><br><span class="line">                <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR=&gt;&#x27;</span>, url, <span class="string">&#x27;==&gt;&#x27;</span>, error)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后返回我们的 <code>Home.js</code> ，在这里处理是否请求数据：</p>
<p>首先给 <code>NewsList</code> 加上 <code>ref</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">lists.<span class="title function_">push</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">NewsList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">ref</span>=<span class="string">&#123;</span>&#x27;<span class="attr">NewsList</span>&#x27; + <span class="attr">index</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;, <span class="attr">width:</span> <span class="attr">width</span>, <span class="attr">height:</span> <span class="attr">height</span> <span class="attr">-</span> <span class="attr">64</span> <span class="attr">-</span> <span class="attr">49</span> <span class="attr">-</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">isRequest</span>=<span class="string">&#123;index</span> == <span class="string">0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">touchIn</span>=<span class="string">&#123;(scrollEnabled)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">            this.refs.ScrollView.setNativeProps(&#123;scrollEnabled: !scrollEnabled&#125;)</span></span><br><span class="line"><span class="language-xml">        &#125;&#125;</span></span><br><span class="line"><span class="language-xml">    /&gt;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>然后在点击 <code>SegmentedView</code> 和滑动 <code>ScrollView</code> 的时候来进行处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">SegmentedView</span></span><br><span class="line">    ref=<span class="string">&quot;SegmentedView&quot;</span></span><br><span class="line">    list=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>&#125;</span><br><span class="line">    style=&#123;&#123;<span class="attr">height</span>: <span class="number">30</span>&#125;&#125;</span><br><span class="line">    selectItem=&#123;<span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">x</span>: width * index, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">animated</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_scrollTo</span>(index)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">ScrollView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">removeClippedSubviews</span>=<span class="string">&#123;Platform.OS</span> === <span class="string">&#x27;ios&#x27;</span>&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">ref</span>=<span class="string">&quot;ScrollView&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">horizontal</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">showsHorizontalScrollIndicator</span>=<span class="string">&#123;false&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">pagingEnabled</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    <span class="attr">onMomentumScrollEnd</span>=<span class="string">&#123;(s)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">        let index = s.nativeEvent.contentOffset.x / width</span></span><br><span class="line"><span class="language-xml">        this.refs.SegmentedView._moveTo(index)</span></span><br><span class="line"><span class="language-xml">        this._scrollTo(index)</span></span><br><span class="line"><span class="language-xml">    &#125;&#125;</span></span><br><span class="line"><span class="language-xml">&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果是第一次显示，那么请求数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_scrollTo</span>(<span class="params">index</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> newsList = <span class="variable language_">this</span>.<span class="property">refs</span>[<span class="string">&#x27;NewsList&#x27;</span> + index]</span><br><span class="line">    newsList.<span class="property">state</span>.<span class="property">isFirstShow</span> &amp;&amp; newsList.<span class="title function_">_onRefresh</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="2-详情页"><a href="#2-详情页" class="headerlink" title="2.详情页"></a>2.详情页</h2><p>详情页进去是一个网页，我们直接写死一个网页。</p>
<p>创建 <code>NewsDetail.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">WebView</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NavigationBar</span> <span class="keyword">from</span> <span class="string">&#x27;../Custom/NavBarCommon&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">NewsDetail</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;详情页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">navigator</span>=<span class="string">&#123;this.props.navigator&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">WebView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;flex:1&#125;&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">source</span>=<span class="string">&#123;&#123;uri:</span> &#x27;<span class="attr">http:</span>//<span class="attr">zjzywap.eastday.com</span>/<span class="attr">m</span>/<span class="attr">170425001829725.html</span>?<span class="attr">fr</span>=<span class="string">toutiao&amp;qid</span>=<span class="string">zjxw&amp;apptypeid</span>=<span class="string">ZJZYIOS1114283782&amp;ime</span>=<span class="string">6271F554-7B2F-45DE-887E-4A336F64DEE6</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<p>然后我们去 <code>NewsList.js</code> 引入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">NewsDetail</span> <span class="keyword">from</span> <span class="string">&#x27;./NewsDetail&#x27;</span></span><br></pre></td></tr></table></figure>


<p>然后我们需要进行 <code>push</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_onPress</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">navigator</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">navigator</span>.<span class="title function_">push</span>(&#123;</span><br><span class="line">        <span class="attr">component</span>: <span class="title class_">NewsDetail</span>,</span><br><span class="line">        <span class="attr">params</span>: &#123;</span><br><span class="line">            <span class="attr">navigator</span>: <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">navigator</span>, <span class="comment">//这个并不用传入, 这里只是为了演示参数的传入</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们 <code>push</code> 需要用到 <code>navigator</code>， 但是的 <code>NewsList</code> 我们并没有给它传入 <code>navigator</code> ，我们需要去 <code>Home.js</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">NewsList</span></span><br><span class="line">    ref=&#123;<span class="string">&#x27;NewsList&#x27;</span> + index&#125;</span><br><span class="line">    key=&#123;index&#125;</span><br><span class="line">    style=&#123;&#123;<span class="attr">backgroundColor</span>:<span class="string">&#x27;white&#x27;</span>, <span class="attr">width</span>: width, <span class="attr">height</span>: height - <span class="number">64</span> - <span class="number">49</span> - <span class="number">30</span>&#125;&#125;</span><br><span class="line">    dic=&#123;dic&#125;</span><br><span class="line">    isRequest=&#123;index == <span class="number">0</span>&#125;</span><br><span class="line">    touchIn=&#123;<span class="function">(<span class="params">scrollEnabled</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">setNativeProps</span>(&#123;<span class="attr">scrollEnabled</span>: !scrollEnabled&#125;)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">    navigator=&#123;<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">navigator</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>然后进行调用</p>
<p>在 <code>renderRow</code> 方法内的 <code>CarousePicture</code> 以及下面的 2 个 <code>TouchableOpacity</code> 加入属性 <code>onPress=&#123;this._onPress&#125;</code></p>
<p>例如这样:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">CarousePicture</span></span><br><span class="line">    index=&#123;<span class="number">5</span>&#125;</span><br><span class="line">    ref=<span class="string">&quot;ScrollView&quot;</span></span><br><span class="line">    rowData=&#123;rowData&#125;</span><br><span class="line">    style=&#123;&#123;width, <span class="attr">height</span>: <span class="number">200</span>&#125;&#125;</span><br><span class="line">    touchIn=&#123;<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">touchIn</span>&#125;</span><br><span class="line">    onPress=&#123;<span class="variable language_">this</span>.<span class="property">_onPress</span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>最后我们需要进入 <code>CarousePicture.js</code> 内的 <code>TouchableWithoutFeedback</code> 来调用回调函数:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> &lt;<span class="title class_">TouchableWithoutFeedback</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">flex</span>:<span class="number">1</span>,width, <span class="attr">height</span>:<span class="number">200</span>, <span class="attr">backgroundColor</span>:<span class="string">&#x27;white&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">onPress</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">onPress</span>()</span><br><span class="line">    &#125;&#125;</span><br><span class="line">    onPressIn=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">touchIn</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">touchIn</span>(<span class="literal">true</span>)</span><br><span class="line">    &#125;&#125;</span><br><span class="line"></span><br><span class="line">    onPressOut=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">touchIn</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">touchIn</span>(<span class="literal">false</span>)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>现在就可以 <code>push</code> 到详情页了</p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative6">项目地址</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/05/03/RN_5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/05/03/RN_5/" class="post-title-link" itemprop="url">React Native (五)：上下拉刷新加载</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-05-03 11:23:00" itemprop="dateCreated datePublished" datetime="2017-05-03T11:23:00+08:00">2017-05-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:19:47" itemprop="dateModified" datetime="2023-12-21T21:19:47+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<h2 id="1-下拉刷新"><a href="#1-下拉刷新" class="headerlink" title="1.下拉刷新"></a>1.下拉刷新</h2><p>下拉刷新我们使用 <code>React Native</code> 提供的组件 <code>RefreshControl</code>，去 <code>NewsList.js</code> 的 <code>ListView</code> 添加：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">ListView</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">flex</span>:<span class="number">1</span>, <span class="attr">backgroundColor</span>:<span class="string">&#x27;white&#x27;</span>&#125;&#125;</span><br><span class="line">    dataSource=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>&#125; <span class="comment">//设置数据源</span></span><br><span class="line">    renderRow=&#123;<span class="variable language_">this</span>.<span class="property">renderRow</span>&#125; <span class="comment">//设置cell</span></span><br><span class="line">    removeClippedSubviews=&#123;<span class="literal">false</span>&#125;</span><br><span class="line">    refreshControl=&#123;</span><br><span class="line">          <span class="language-xml"><span class="tag">&lt;<span class="name">RefreshControl</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">refreshing</span>=<span class="string">&#123;this.state.isRefreshing&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">onRefresh</span>=<span class="string">&#123;()</span> =&gt;</span> this._onRefresh(1)&#125;</span></span><br><span class="line"><span class="language-xml">            tintColor=&quot;#999999&quot;</span></span><br><span class="line"><span class="language-xml">            title=&quot;加载中...&quot;</span></span><br><span class="line"><span class="language-xml">            titleColor=&quot;#999999&quot;</span></span><br><span class="line"><span class="language-xml">            colors=&#123;[&#x27;#ff0000&#x27;, &#x27;#00ff00&#x27;, &#x27;#0000ff&#x27;]&#125;</span></span><br><span class="line"><span class="language-xml">            progressBackgroundColor=&quot;#ffff00&quot;</span></span><br><span class="line"><span class="language-xml">          /&gt;</span></span><br><span class="line">    &#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p><code>ListView</code> 新加了一个属性 <code>removeClippedSubviews</code>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/issues/1831">原因</a></p>
<p>我们需要给 <code>state</code> 添加一个 <code>key</code> ： <code>isRefreshing: false</code> ，然后在网络请求时对它进行处理，（我这里省略了一些代码，要不然太长）</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_begainRefresh</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isRefreshing</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">_endRefresh</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isRefreshing</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">_onRefresh</span>(<span class="params">page</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_begainRefresh</span>()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (page == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                page</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_endRefresh</span>()</span><br><span class="line"></span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span> &#123;</span><br><span class="line">                    ..... 数据的处理</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">_endRefresh</span>()</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在运行程序就可以尽情地下拉刷新了。</p>
<h2 id="2-上拉加载"><a href="#2-上拉加载" class="headerlink" title="2.上拉加载"></a>2.上拉加载</h2><p>上拉加载我们利用 <code>ListView</code> 的 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/listview.html#onendreached">onEndReached</a> 方法来进行加载新数据，使用 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/listview.html#renderfooter">renderFooter</a> 来进行显示状态。</p>
<p>这样严格的来说并不算上拉加载，只是滑动到底部自动进行加载。</p>
<p>首先在 <code>ListView</code> 加入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">onEndReached=&#123; <span class="variable language_">this</span>.<span class="property">_toEnd</span> &#125;</span><br><span class="line">onEndReachedThreshold=&#123;<span class="number">10</span>&#125;</span><br><span class="line">renderFooter=&#123; <span class="variable language_">this</span>.<span class="property">_renderFooter</span> &#125;</span><br></pre></td></tr></table></figure>

<p>记得进行绑定</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">_toEnd</span> = <span class="variable language_">this</span>.<span class="property">_toEnd</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_renderFooter</span> = <span class="variable language_">this</span>.<span class="property">_renderFooter</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_toEnd</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isRefreshing</span>) <span class="keyword">return</span>  </span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_onRefresh</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">_renderFooter</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:</span> <span class="attr">40</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">FFFFFF</span>&#x27;, <span class="attr">alignItems:</span>&#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span>&gt;</span>正在加载更多...<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们需要对数据进行处理，保存请求到的数据，再下一页数据请求到后加入数组，我们给 <code>state</code> 加入一个 <code>data: []</code>，然后对请求到的数据进行处理：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> list = json.<span class="property">NewsList</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> swipers = []</span><br><span class="line"><span class="keyword">let</span> news = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (page == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">        <span class="keyword">let</span> dic = list[index]</span><br><span class="line">        index &lt; <span class="number">4</span> ? swipers.<span class="title function_">push</span>(dic) : news.<span class="title function_">push</span>(dic)</span><br><span class="line">    &#125;</span><br><span class="line">    news.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">0</span>, swipers)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    news = list</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> newData = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">data</span>.<span class="title function_">concat</span>(news)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(newData),</span><br><span class="line">    <span class="attr">data</span>: newData,</span><br><span class="line">    <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span> + (list.<span class="property">length</span> == maxCount ? <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的 <code>maxCount</code> 是为了方便管理的，定义为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> maxCount = <span class="number">20</span></span><br></pre></td></tr></table></figure>

<p>请求的 <code>url</code> 改为 :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newspush/list/index.html?clientid=1114283782&amp;v=1.1&amp;type=&#x27;</span></span><br><span class="line">        + <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>.<span class="property">NameEN</span></span><br><span class="line">        + <span class="string">&#x27;&amp;startkey=3001_9223370543834829200_537d522d125e32ae&amp;newkey=&amp;index=&#x27;</span></span><br><span class="line">        + page</span><br><span class="line">        + <span class="string">&#x27;&amp;size=&#x27;</span></span><br><span class="line">        + maxCount</span><br><span class="line">        + <span class="string">&#x27;&amp;ime=6271F554-7B2F-45DE-887E-4A336F64DEE6&amp;apptypeid=ZJZYIOS1114283782&#x27;</span></span><br></pre></td></tr></table></figure>

<p>现在可以运行看看效果了。</p>
<p>我们会发现一开始在加载第一页数据的时候 <code>Footer</code> 也显示了出来，我们需要控制它的显示与隐藏，给 <code>state</code> 加入 <code>showFooter: false</code> ，在第一页数据加载完成并且返回的数组元素个数等于 <code>maxCount</code> 则赋值为 <code>true</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(newData),</span><br><span class="line">    <span class="attr">data</span>: newData,</span><br><span class="line">    <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span> + (list.<span class="property">length</span> == maxCount ? <span class="number">1</span> : <span class="number">0</span>),</span><br><span class="line">    <span class="attr">showFooter</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span> ? <span class="literal">true</span> :  (list.<span class="property">length</span> == maxCount ? <span class="literal">true</span> : <span class="literal">false</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_renderFooter</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:</span> <span class="attr">40</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">FFFFFF</span>&#x27;, <span class="attr">alignItems:</span>&#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span>&gt;</span>正在加载更多<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在 <code>Footer</code> 可以正确的显示隐藏了，但是我们还需要状态来改变 <code>Footer</code> 显示的文字，如果还有更多数据，那我们看见 <code>Footer</code> 的时候它的状态显然是正在加载更多，如果没有更多数据了，那我们就显示 已加载全部 。</p>
<p>给 <code>state</code> 加入 <code>hasMore: true</code> ，我们先假设它还有更多</p>
<p>然后在请求到数据进行处理:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> hasMore = list.<span class="property">length</span> == maxCount ? <span class="literal">true</span> : <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(newData),</span><br><span class="line">    <span class="attr">data</span>: newData,</span><br><span class="line">    <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span> + (hasMore ? <span class="number">1</span> : <span class="number">0</span>),</span><br><span class="line">    <span class="attr">showFooter</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span> ? <span class="literal">true</span> :  (hasMore ? <span class="literal">true</span> : <span class="literal">false</span>),</span><br><span class="line">    hasMore,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然后处理 <code>renderFooter</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_renderFooter</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">showFooter</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:</span> <span class="attr">40</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">FFFFFF</span>&#x27;, <span class="attr">alignItems:</span>&#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span>&gt;</span>&#123;this.state.hasMore ? &#x27;正在加载更多...&#x27; : &#x27;已加载全部&#x27;&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还需要再 <code>toEnd</code> 的判断条件加入 <code>hasMore</code> 来避免显示没有更多数据的时候拉倒底部还会进行请求数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_toEnd</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isRefreshing</span> || !<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">hasMore</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_onRefresh</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到现在上下拉刷新已经完成</p>
<p>这个上拉刷新比较简陋，你也可以放 <code>gif图</code> 或者使用 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/animations.html#content">动画</a> 来让界面变好看点。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative5">项目地址</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/24/RN_4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/24/RN_4/" class="post-title-link" itemprop="url">React Native (四)：加载新闻列表</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-24 12:08:00" itemprop="dateCreated datePublished" datetime="2017-04-24T12:08:00+08:00">2017-04-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:19:20" itemprop="dateModified" datetime="2023-12-21T21:19:20+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<h2 id="1-标签与内容页联动"><a href="#1-标签与内容页联动" class="headerlink" title="1.标签与内容页联动"></a>1.标签与内容页联动</h2><p>上一节做到了点击标签自动移动，还差跟下面的视图进行联动。</p>
<p>首先创建 <code>NewsList.js</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">ListView</span>,</span><br><span class="line">    <span class="title class_">Image</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Dimensions</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"><span class="keyword">const</span> &#123;width, height&#125; = <span class="title class_">Dimensions</span>.<span class="title function_">get</span>(<span class="string">&#x27;window&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">NewsList</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123;style&#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.view,style]&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>:<span class="string">&#x27;red&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>然后在 <code>Home.js</code> 引入，再加入 <code>ScrollView</code> ，现在 <code>Home.js</code> 的 <code>redner()</code> 是这样子的，这里加入的 <code>ScrollView</code> 我们在后文中称为 <code>NewsScrollView</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;首页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">unLeftImage</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SegmentedView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">ref</span>=<span class="string">&quot;SegmentedView&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">list</span>=<span class="string">&#123;this.state.list&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ScrollView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">ref</span>=<span class="string">&quot;ScrollView&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">horizontal</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">showsHorizontalScrollIndicator</span>=<span class="string">&#123;false&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">pagingEnabled</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    &#123; this._getNewsLists()&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">           <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>_getNewsLists()</code> 方法： </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_getNewsLists</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> lists = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>[index]</span><br><span class="line">            lists.<span class="title function_">push</span>(</span><br><span class="line">                <span class="language-xml"><span class="tag">&lt;<span class="name">NewsList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span>&#x27;#&#x27; + <span class="attr">this._getColor</span>(&#x27;&#x27;,<span class="attr">0</span>), <span class="attr">width:</span> <span class="attr">width</span>, <span class="attr">height:</span> <span class="attr">height</span> <span class="attr">-</span> <span class="attr">49</span> <span class="attr">-</span> <span class="attr">64</span> <span class="attr">-</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lists</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">_getColor</span>(<span class="params">color, index</span>) &#123;</span><br><span class="line"></span><br><span class="line">    index ++</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (index == <span class="number">7</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> color</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    color = color + <span class="string">&#x27;0123456789abcdef&#x27;</span>[<span class="title class_">Math</span>.<span class="title function_">floor</span>(<span class="title class_">Math</span>.<span class="title function_">random</span>()*<span class="number">16</span>)]</span><br><span class="line">    <span class="keyword">return</span>  <span class="variable language_">this</span>.<span class="title function_">_getColor</span>(color, index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>根据返回的数据创建对应数量的视图，给随机颜色方便看效果。</p>
<p>先设置滑动 <code>NewsScrollView </code> 让标签跟着移动。</p>
<p>我们把 <code>SegmentedView</code> 中 <code>items.push</code> 中的 <code>onPress</code> 方法的实现单独写到一个方法里，然后在这里调用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_moveTo</span>(<span class="params">index</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; list &#125; = <span class="variable language_">this</span>.<span class="property">props</span>  <span class="comment">//获取到 传入的数组</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (list.<span class="property">length</span> &gt; maxItem) &#123;</span><br><span class="line">        <span class="keyword">let</span> meiosis = <span class="built_in">parseInt</span>(maxItem / <span class="number">2</span>)</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">x</span>: (index - meiosis &lt; <span class="number">0</span> ? <span class="number">0</span> : index - meiosis &gt; list.<span class="property">length</span> - maxItem ? list.<span class="property">length</span> - maxItem : index - meiosis ) * <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">itemWidth</span>, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">animated</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会发现我们给 <code>this.state</code> 加了一个 <code>itemWidth</code> ，原来我们获取 <code>itemWidth</code> 是在 <code>_getItems()</code> 中计算的，但是在渲染的过程中无法调用 <code>setState()</code> ，我们把计算 <code>itemWidth</code> 的方法移动到 :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentWillReceiveProps</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; list &#125; = props  <span class="comment">//获取到 传入的数组</span></span><br><span class="line">    <span class="keyword">if</span> (!list || list.<span class="property">length</span> == <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算每个标签的宽度</span></span><br><span class="line">    <span class="keyword">let</span> itemWidth = width / list.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (list.<span class="property">length</span> &gt; maxItem) &#123;</span><br><span class="line">        itemWidth = width / maxItem</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        itemWidth</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p><code>componentWillReceiveProps(props)</code> 方法会在属性更新后调用，参数 <code>props</code> 是新的属性。</p>
<p>现在运行会发现点击标签可以正常改变标签的状态，然而拖动 <code>NewsScrollView </code> 只会让上一个选中的变为未选中，新的标签并没有变为选中，这是因为选中状态只在标签被点击的时候进行了设置，我们需要给 <code>Item</code> 添加一个选中的方法 ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title function_">_select</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isSelect</span>: <span class="literal">true</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在 <code>_moveTo(index)</code> 进行调用:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>()</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_select</span>()</span><br></pre></td></tr></table></figure>

<p>现在运行滑动 <code>NewsScrollView </code> 上面的 <code>SegmentedView</code> 可以正常运行了。</p>
<p>最后设置点击标签可以让 <code>NewsScrollView</code> 滑动到对应的位置，我们需要给 <code>SegmentedView</code> 加入一个回调函数，在标签被点击的时候调用返回点击的 <code>index</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">SegmentedView</span></span><br><span class="line">    ref=<span class="string">&quot;SegmentedView&quot;</span></span><br><span class="line">    list=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>&#125;</span><br><span class="line">    style=&#123;&#123;<span class="attr">height</span>: <span class="number">30</span>&#125;&#125;</span><br><span class="line">    selectItem=&#123;<span class="function">(<span class="params">index</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">x</span>: width * index, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">animated</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>在 <code>SegmentedView </code> 进行调用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_getItems</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; list, selectItem &#125; = <span class="variable language_">this</span>.<span class="property">props</span>  <span class="comment">//获取到 传入的数组</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!list || list.<span class="property">length</span> == <span class="number">0</span>) <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> items = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">        <span class="keyword">let</span> dic = list[index]</span><br><span class="line">        items.<span class="title function_">push</span>(</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">Item</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">ref</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">isSelect</span>=<span class="string">&#123;index</span> == <span class="string">0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">itemHeight</span>=<span class="string">&#123;this.state.itemHeight&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">itemWidth</span>=<span class="string">&#123;this.state.itemWidth&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">onPress</span>=<span class="string">&#123;()</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                    this._moveTo(index)</span></span><br><span class="line"><span class="language-xml">                    selectItem &amp;&amp; selectItem(index)</span></span><br><span class="line"><span class="language-xml">                &#125;&#125;</span></span><br><span class="line"><span class="language-xml">            /&gt;</span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> items</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2-加载新闻列表第一页数据"><a href="#2-加载新闻列表第一页数据" class="headerlink" title="2.加载新闻列表第一页数据"></a>2.加载新闻列表第一页数据</h2><p>在 <code>Home.js</code> 中已经给 <code>NewsList</code> 传入了数据，我们再给传入一个参数识别是否是第一页，初始只加载第一页的数据，也方便调试：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_getNewsLists</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> lists = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>[index]</span><br><span class="line">            lists.<span class="title function_">push</span>(</span><br><span class="line">                <span class="language-xml"><span class="tag">&lt;<span class="name">NewsList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">isRequest</span>=<span class="string">&#123;index</span> == <span class="string">0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lists</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后去 <code>NewsList.js</code> 进行请求数据:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"> <span class="comment">// 构造</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="comment">// 初始状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">        <span class="attr">page</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">rn</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">isRequest</span>) <span class="keyword">return</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_onRefresh</span>()</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"> <span class="title function_">_onRefresh</span>(<span class="params">page</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newspush/list/index.html?clientid=1114283782&amp;v=1.1&amp;type=&#x27;</span></span><br><span class="line">            + <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">dic</span>.<span class="property">NameEN</span></span><br><span class="line">            + <span class="string">&#x27;&amp;startkey=&amp;newkey=&amp;index=&#x27;</span></span><br><span class="line">            + (page ? page : <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">page</span>)</span><br><span class="line">            + <span class="string">&#x27;&amp;size=20&amp;ime=6271F554-7B2F-45DE-887E-4A336F64DEE6&amp;apptypeid=ZJZYIOS1114283782&amp;rn=&#x27;</span></span><br><span class="line">            + <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">rn</span></span><br><span class="line"></span><br><span class="line">        <span class="title function_">LOG</span>(<span class="string">&#x27;url=》&#x27;</span>, url)</span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET SUCCESSED then =&gt;&#x27;</span>, url, json)</span><br><span class="line"></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR then =&gt;&#x27;</span>, url, e)</span><br><span class="line"></span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR=&gt;&#x27;</span>, url, <span class="string">&#x27;==&gt;&#x27;</span>, error)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求到数据后我们需要用 <code>ListView</code> (<a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/listview.html#content">官方文档</a>) 来显示， 所以导入 <code>ListView</code> ，然后去 <code>render()</code> 加入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;style&#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.view,style]&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">ListView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">style</span>=<span class="string">&#123;&#123;flex:1&#125;&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">dataSource</span>=<span class="string">&#123;this.state.dataSource&#125;</span> //<span class="attr">设置数据源</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">renderRow</span>=<span class="string">&#123;this.renderRow&#125;</span> //<span class="attr">设置cell</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后加入 <code>dataSource</code> 和 <code>renderRow</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 构造</span></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> <span class="title function_">getRowData</span> = (<span class="params">dataBlob, sectionID, rowID</span>) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> dataBlob[sectionID][rowID]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 初始状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attr">page</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">rn</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">dataSource</span>: <span class="keyword">new</span> <span class="title class_">ListView</span>.<span class="title class_">DataSource</span>(&#123;</span><br><span class="line">            <span class="attr">getRowData</span>: getRowData,</span><br><span class="line">            <span class="attr">rowHasChanged</span>: <span class="function">(<span class="params">r1, r2</span>) =&gt;</span> r1 !== r2,</span><br><span class="line">        &#125;),</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">renderRow</span> = <span class="variable language_">this</span>.<span class="property">renderRow</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="title function_">renderRow</span>(<span class="params">rowData, rowID, highlightRow</span>) &#123;</span><br><span class="line">	<span class="keyword">return</span> (</span><br><span class="line">		<span class="language-xml"><span class="tag">&lt;<span class="name">View</span> /&gt;</span></span></span><br><span class="line">	)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>我们要做的界面是这个样子</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative4/news_list.png?raw=true"></p>
<p>从上图可以看出来新闻分为 3 种样式，轮播图、有一张图片的和二、三张图片的。</p>
<p>接下来开始解析数据，解析完 <code>json</code> 数据发现只有一个数组，轮播图是取了前四个，剩下的根据 <code>ImagesList</code> 里图片的个数来判断，</p>
<p>去 <code>.then((json) =&gt; &#123;</code> 加入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> list = json.<span class="property">NewsList</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> swipers = []</span><br><span class="line"><span class="keyword">let</span> news = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">    <span class="keyword">let</span> dic = list[index]</span><br><span class="line">    index &lt; <span class="number">4</span> ? swipers.<span class="title function_">push</span>(dic) : news.<span class="title function_">push</span>(dic)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">news.<span class="title function_">splice</span>(<span class="number">0</span>, <span class="number">0</span>, swipers)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">    <span class="attr">dataSource</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">dataSource</span>.<span class="title function_">cloneWithRows</span>(news)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>现在 <code>news</code> 的数据结构为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">	[</span><br><span class="line">		&#123;&#125;,</span><br><span class="line">		&#123;&#125;</span><br><span class="line">	],</span><br><span class="line">	</span><br><span class="line">	&#123;&#125;,</span><br><span class="line">	&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后去 <code>renderRow</code> 处理数据</p>
<p>如果是数组，那么返回轮播图：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(rowData) === <span class="string">&#x27;[object Array]&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">CarousePicture</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">index</span>=<span class="string">&#123;2&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">ref</span>=<span class="string">&quot;ScrollView&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">rowData</span>=<span class="string">&#123;rowData&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:</span> <span class="attr">200</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">touchIn</span>=<span class="string">&#123;this.props.touchIn&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        &gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">CarousePicture</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的轮播图本来用的 <a target="_blank" rel="noopener" href="https://github.com/leecade/react-native-swiper"><code>Swiper</code></a>，但是在 <code>Android</code> 上有很多 BUG，我只好自己写了一个，但是在 <code>Android</code> 上的体验差强人意，源码在<a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative4/App/Home/CarousePicture.js">这里</a>，把文件导入项目即可。</p>
<p>具体的可以看<a target="_blank" rel="noopener" href="http://jiasm.org/2017/02/18/React-native%E8%B8%A9%E5%9D%91%E5%B0%8F%E8%AE%B0/">这里</a></p>
<p><code>touchIn</code> 是由于在 <code>Andoird</code> 上两个 <code>ScrollView</code> 重叠时，处于顶部的 <code>ScrollView</code> 滑动事件不会响应，因为底部的 <code>ScrollView</code> 进行了响应并拦截了事件，我们需要在手指接触到轮播图的时候禁用底部 <code>ScrollView</code> 的滑动属性，再手指离开的时候再进行恢复，所以还需要去 <code>Home.js</code> 加入：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> <span class="title function_">_getNewsLists</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> lists = []</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">list</span>[index]</span><br><span class="line">            lists.<span class="title function_">push</span>(</span><br><span class="line">                <span class="language-xml"><span class="tag">&lt;<span class="name">NewsList</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;, <span class="attr">width:</span> <span class="attr">width</span>, <span class="attr">height:</span> <span class="attr">height</span> <span class="attr">-</span> <span class="attr">64</span> <span class="attr">-</span> <span class="attr">49</span> <span class="attr">-</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">isRequest</span>=<span class="string">&#123;index</span> == <span class="string">0&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">touchIn</span>=<span class="string">&#123;(scrollEnabled)</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">                        this.refs.ScrollView.setNativeProps(&#123;scrollEnabled: !scrollEnabled&#125;)</span></span><br><span class="line"><span class="language-xml">                    &#125;&#125;</span></span><br><span class="line"><span class="language-xml">                /&gt;</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> lists</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>然后根据 <code>ImagesList</code> 的个数来区分：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> imagesList = rowData.<span class="property">ImagesList</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (imagesList &amp;&amp; imagesList.<span class="property">length</span> == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">TouchableOpacity</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span>  <span class="attr">backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">View</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;, <span class="attr">flexDirection:</span>&#x27;<span class="attr">row</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">space-between</span>&#x27;, <span class="attr">flex:1</span>&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Image</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">resizeMode</span>=<span class="string">&quot;cover&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;marginTop:</span> <span class="attr">10</span>, <span class="attr">marginBottom:10</span>, <span class="attr">marginLeft:</span> <span class="attr">10</span>, <span class="attr">width:</span> <span class="attr">80</span>, <span class="attr">height:</span> <span class="attr">80</span>, <span class="attr">backgroundColor:</span>&#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">source</span>=<span class="string">&#123;&#123;uri:imagesList[0].ImgPath&#125;&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">View</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">marginRight:</span> <span class="attr">10</span>,<span class="attr">backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;, <span class="attr">marginTop:</span> <span class="attr">10</span>, <span class="attr">height:</span> <span class="attr">80</span>, <span class="attr">width:</span> <span class="attr">width</span> <span class="attr">-</span> <span class="attr">110</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Text</span>&gt;</span>&#123;rowData.Title&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;flex:1,</span> <span class="attr">flexDirection:</span> &#x27;<span class="attr">row</span>&#x27;, <span class="attr">justifyContent:</span> &#x27;<span class="attr">space-between</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginTop:10,</span> <span class="attr">fontSize:</span> <span class="attr">13</span>, <span class="attr">color:</span> &#x27;#<span class="attr">999999</span>&#x27;&#125;&#125;&gt;</span>&#123;rowData.Source&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginRight:0,marginTop:10,fontSize:</span> <span class="attr">13</span>, <span class="attr">color:</span> &#x27;#<span class="attr">999999</span>&#x27;&#125;&#125;&gt;</span>&#123;rowData.PublishTime&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:1</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">TouchableOpacity</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> images = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> imagesList) &#123;</span><br><span class="line">    <span class="keyword">let</span> dic = imagesList[index]</span><br><span class="line">    images.<span class="title function_">push</span>(</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">Image</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">resizeMode</span>=<span class="string">&quot;cover&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">style</span>=<span class="string">&#123;&#123;marginRight:</span> <span class="attr">10</span>, <span class="attr">marginLeft:</span> <span class="attr">index</span> == <span class="string">0</span> ? <span class="attr">10</span> <span class="attr">:</span> <span class="attr">0</span>, <span class="attr">marginTop:10</span>, <span class="attr">marginBottom:</span> <span class="attr">10</span>,<span class="attr">flex:1</span>, <span class="attr">height:</span> <span class="attr">90</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            <span class="attr">source</span>=<span class="string">&#123;&#123;uri:dic.ImgPath&#125;&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        /&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">TouchableOpacity</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span>  <span class="attr">backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,backgroundColor:</span>&#x27;<span class="attr">white</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginLeft:</span> <span class="attr">10</span>, <span class="attr">marginTop:</span> <span class="attr">10</span>&#125;&#125;&gt;</span>&#123;rowData.Title&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;flexDirection:</span>&#x27;<span class="attr">row</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            &#123;images&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;flex:1,</span> <span class="attr">flexDirection:</span> &#x27;<span class="attr">row</span>&#x27;, <span class="attr">justifyContent:</span> &#x27;<span class="attr">space-between</span>&#x27;&#125;&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginLeft:</span> <span class="attr">10</span>, <span class="attr">marginBottom:</span> <span class="attr">10</span>,<span class="attr">fontSize:</span> <span class="attr">13</span>, <span class="attr">color:</span> &#x27;#<span class="attr">999999</span>&#x27;&#125;&#125;&gt;</span>&#123;rowData.Source&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;&#123;marginRight:10,fontSize:</span> <span class="attr">13</span>, <span class="attr">marginBottom:</span> <span class="attr">10</span>,<span class="attr">color:</span> &#x27;#<span class="attr">999999</span>&#x27;&#125;&#125;&gt;</span>&#123;rowData.PublishTime&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;&#123;width,</span> <span class="attr">height:1</span>, <span class="attr">backgroundColor:</span> &#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;&gt;</span><span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">TouchableOpacity</span>&gt;</span></span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>我这里的 <code>style</code> 没有进行整理，所以看着比较乱，正式开发中应该整理到 <code>styles</code> 里，看起来就简洁多了。</p>
<p>现在运行就可以显示第一页的数据了。</p>
<p>下篇文章处理上下拉刷新加载。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/18/RN_3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/18/RN_3/" class="post-title-link" itemprop="url">React Native (三)： 自定义视图</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-18 18:41:00" itemprop="dateCreated datePublished" datetime="2017-04-18T18:41:00+08:00">2017-04-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:18:42" itemprop="dateModified" datetime="2023-12-21T21:18:42+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<p>这次我们要做的仿 <code>新闻头条</code> 的首页的顶部标签列表，不要在意新闻内容。</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative3/IMG_1169.PNG?raw=true"></p>
<h2 id="1-请求数据"><a href="#1-请求数据" class="headerlink" title="1.请求数据"></a>1.请求数据</h2><p>首先做顶部的目录视图，首先我们先获取数据：</p>
<p>在 <code>Home.js</code> 中加入方法:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newscategory/list/index.html?clientid=1114283782&amp;v=1.1&#x27;</span></span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span>&#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET SUCCESS =&gt;&#x27;</span>,url, json)</span><br><span class="line"></span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR then =&gt;&#x27;</span>,url,e)</span><br><span class="line"></span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR=&gt;&#x27;</span>,url, <span class="string">&#x27;==&gt;&#x27;</span>,error)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>componentDidMount()</code>是在此页面加载完成后由系统调用。</p>
<p>用到的 <code>LOG</code> 需要在 <code>setup.js</code> 添加全局方法 :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">global</span>.<span class="property">LOG</span> = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(__DEV__)&#123;</span><br><span class="line">        <span class="comment">// debug模式</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;/------------------------------\\&#x27;</span>);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(...args);</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;\\------------------------------/&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> args[args.<span class="property">length</span> - <span class="number">1</span>];</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// release模式</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>完整的生命周期可以看这个 <a target="_blank" rel="noopener" href="https://facebook.github.io/react/docs/react-component.html">文档</a></p>
<p>我们使用 <code>fetch</code> 进行请求数据，你也可以用 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/network.html#content">这里</a> 的方法进行请求数据。</p>
<p>注意在 <code>iOS</code> 中需要去 <code>Xcode</code> 打开 <code>ATS</code>。</p>
<h2 id="2-自定义视图"><a href="#2-自定义视图" class="headerlink" title="2.自定义视图"></a>2.自定义视图</h2><p>在 <code>Home</code> 文件夹内创建 <code>SegmentedView.js</code></p>
<p>先定义一个基础的 <code>View</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Dimensions</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"><span class="keyword">const</span> &#123;width, height&#125; = <span class="title class_">Dimensions</span>.<span class="title function_">get</span>(<span class="string">&#x27;window&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">SegmentedView</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; style &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.view,</span> <span class="attr">style</span>]&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">              </span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">height</span>: <span class="number">50</span>,</span><br><span class="line">        <span class="attr">width</span>: width,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<p>这里的 <code>const &#123;width, height&#125; = Dimensions.get(&#39;window&#39;)</code> 是获取到的屏幕的宽和高。</p>
<p>然后在 <code>Home.js</code> 加入 <code>SegmentedView</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">SegmentedView</span> <span class="keyword">from</span> <span class="string">&#x27;./SegmentedView&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;首页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">unLeftImage</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SegmentedView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>SegmentedView</code> 中 <code>const &#123; style &#125; = this.props</code> 获取到的就是这里设置的 <code>style=&#123;height: 30&#125;</code> 。</p>
<p> <code>&lt;View style=&#123;[styles.view, style]&#125;&gt;</code> 这样设置样式，数组中的每一个样式都会覆盖它前面的样式，不过只会覆盖有的 <code>key-value</code>，比如这里 <code>style=&#123;height: 30&#125;</code> ，它只会覆盖掉前面的 <code>height</code> ，最终的样式为 :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">height</span>: <span class="number">30</span>,</span><br><span class="line">    <span class="attr">width</span>: width,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>


<h2 id="3-传数据"><a href="#3-传数据" class="headerlink" title="3.传数据"></a>3.传数据</h2><p>请求到的数据需要传给 <code>SegmentedView</code> 来创建视图，我们在 <code>Home.js</code> 加入构造，现在的 <code>Home.js</code> 是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NavigationBar</span> <span class="keyword">from</span> <span class="string">&#x27;../Custom/NavBarCommon&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">SegmentedView</span> <span class="keyword">from</span> <span class="string">&#x27;./SegmentedView&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Home</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造</span></span><br><span class="line">      <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="comment">// 初始状态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">list</span>: <span class="literal">null</span></span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> url = <span class="string">&#x27;http://api.iapple123.com/newscategory/list/index.html?clientid=1114283782&amp;v=1.1&#x27;</span></span><br><span class="line">        <span class="title function_">fetch</span>(url, &#123;</span><br><span class="line">            <span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span><br><span class="line">            <span class="attr">headers</span>: &#123;</span><br><span class="line">                <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;)</span><br><span class="line">            .<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">                res.<span class="title function_">json</span>()</span><br><span class="line">                    .<span class="title function_">then</span>(<span class="function">(<span class="params">json</span>) =&gt;</span>&#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET SUCCESS =&gt;&#x27;</span>,url, json)</span><br><span class="line"></span><br><span class="line">                        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                            <span class="attr">list</span>: json.<span class="property">CategoryList</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">                        <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR then =&gt;&#x27;</span>,url,e)</span><br><span class="line">                    &#125;)</span><br><span class="line">            &#125;)</span><br><span class="line">            .<span class="title function_">catch</span>(<span class="function">(<span class="params">error</span>) =&gt;</span> &#123;</span><br><span class="line">                <span class="title function_">LOG</span>(<span class="string">&#x27;GET ERROR=&gt;&#x27;</span>,url, <span class="string">&#x27;==&gt;&#x27;</span>,error)</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;首页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">unLeftImage</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">SegmentedView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">list</span>=<span class="string">&#123;this.state.list&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">30</span>&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>


<p>再数据请求完成后调用 <code>setState()</code> ，系统会收集需要更改的地方然后刷新页面，所以这个方法永远是异步的。</p>
<p>现在请求完数据后就会把数组传给 <code>SegmentedView</code> 了。</p>
<p>再看 <code>SegmentedView</code> ，我们需要用一个 <code>ScrollView</code> 来放置这些标签：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">TouchableOpacity</span>,</span><br><span class="line">    <span class="title class_">Dimensions</span>,</span><br><span class="line">    <span class="title class_">ScrollView</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123;width, height&#125; = <span class="title class_">Dimensions</span>.<span class="title function_">get</span>(<span class="string">&#x27;window&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 一 屏最大数量, 为了可以居中请设置为 奇数</span></span><br><span class="line"><span class="keyword">const</span> maxItem = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">SegmentedView</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造</span></span><br><span class="line">      <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">       <span class="comment">// 初始状态</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">itemHeight</span>: <span class="number">50</span>,</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (props.<span class="property">style</span> &amp;&amp; props.<span class="property">style</span>.<span class="property">height</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">                  ...<span class="variable language_">this</span>.<span class="property">state</span>,</span><br><span class="line">                  <span class="attr">itemHeight</span>: props.<span class="property">style</span>.<span class="property">height</span>,  <span class="comment">//如果在使用的地方设置了高度,那么保存起来方便使用</span></span><br><span class="line">              &#125;;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">_getItems</span> = <span class="variable language_">this</span>.<span class="property">_getItems</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_getItems</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> &#123; list &#125; = <span class="variable language_">this</span>.<span class="property">props</span>  <span class="comment">//获取到 传入的数组</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!list || list.<span class="property">length</span> == <span class="number">0</span>) <span class="keyword">return</span> []</span><br><span class="line"></span><br><span class="line">       <span class="comment">// 计算每个标签的宽度</span></span><br><span class="line">        <span class="keyword">let</span> itemWidth = width / list.<span class="property">length</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list.<span class="property">length</span> &gt; maxItem) &#123;</span><br><span class="line">            itemWidth = width / maxItem</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> items = []</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index <span class="keyword">in</span> list) &#123;</span><br><span class="line">            <span class="keyword">let</span> dic = list[index]</span><br><span class="line">            items.<span class="title function_">push</span>(</span><br><span class="line">                <span class="language-xml"><span class="tag">&lt;<span class="name">View</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">this.state.itemHeight</span>, <span class="attr">width:</span> <span class="attr">itemWidth</span>, <span class="attr">alignItems:</span> &#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;,<span class="attr">backgroundColor:</span>&#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    &#123;/* justifyContent: 主轴居中, alignItems: 次轴居中 */&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Text</span>&gt;</span>&#123;dic.NameCN&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> items</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; style &#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;[styles.view,</span> <span class="attr">style</span>]&#125;&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ScrollView</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">style</span>=<span class="string">&#123;styles.scrollView&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">horizontal</span>=<span class="string">&#123;true&#125;</span> //<span class="attr">横向显示</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">showsHorizontalScrollIndicator</span>=<span class="string">&#123;false&#125;</span> //<span class="attr">隐藏横向滑动条</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                &gt;</span></span></span><br><span class="line"><span class="language-xml">                    &#123;this._getItems()&#125;</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ScrollView</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">height</span>: <span class="number">50</span>,</span><br><span class="line">        <span class="attr">width</span>: width,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="attr">scrollView</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;#EEEEEE&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="4-使标签可选并改变偏移量"><a href="#4-使标签可选并改变偏移量" class="headerlink" title="4.使标签可选并改变偏移量"></a>4.使标签可选并改变偏移量</h2><p>现在运行已经可以显示出标签列表了，我们还需要能点击，有选中和未选中状态，所以我们把数组中添加的视图封装一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Item</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> &#123;itemHeight, itemWidth, dic&#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">TouchableOpacity</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                <span class="attr">style</span>=<span class="string">&#123;&#123;height:</span> <span class="attr">itemHeight</span>, <span class="attr">width:</span> <span class="attr">itemWidth</span>, <span class="attr">alignItems:</span> &#x27;<span class="attr">center</span>&#x27;, <span class="attr">justifyContent:</span>&#x27;<span class="attr">center</span>&#x27;,<span class="attr">backgroundColor:</span>&#x27;#<span class="attr">EEEEEE</span>&#x27;&#125;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">            &gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/* justifyContent: 主轴居中, alignItems: 次轴居中 */&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Text</span>&gt;</span>&#123;dic.NameCN&#125;<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">TouchableOpacity</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们需要可以点击，所以把 <code>View</code> 换成了 <code>TouchableOpacity</code>，记得在顶部导入。</p>
<p>然后修改数组的 <code>push</code> 方法</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">items.<span class="title function_">push</span>(</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Item</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">key</span>=<span class="string">&#123;index&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">itemHeight</span>=<span class="string">&#123;this.state.itemHeight&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">itemWidth</span>=<span class="string">&#123;itemWidth&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">dic</span>=<span class="string">&#123;dic&#125;</span>   </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    /&gt;</span></span></span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>现在运行已经可以点击了，接下来设置选中和未选中样式，在 <code>Item</code> 内加入:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(props);</span><br><span class="line">    <span class="comment">// 初始状态</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">        <span class="attr">isSelect</span>: <span class="literal">false</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>Text</code> 加入样式:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Text</span> style=&#123;&#123;<span class="attr">color</span>: <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">isSelect</span> ? <span class="string">&#x27;red&#x27;</span> : <span class="string">&#x27;black&#x27;</span>&#125;&#125;&gt;&#123;dic.<span class="property">NameCN</span>&#125;&lt;/<span class="title class_">Text</span>&gt;</span><br></pre></td></tr></table></figure>

<p>在 <code>TouchableOpacity</code> 加入点击事件：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">TouchableOpacity</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">height</span>: itemHeight, <span class="attr">width</span>: itemWidth, <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>, <span class="attr">justifyContent</span>:<span class="string">&#x27;center&#x27;</span>,<span class="attr">backgroundColor</span>:<span class="string">&#x27;#EEEEEE&#x27;</span>&#125;&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">isSelect</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在标签已经可以进行点击，点击后变红，我们需要处理点击后让上一个选中的变为未选中，我们给 <code>Item</code> 加一个方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">_unSelect</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">isSelect</span>: <span class="literal">false</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们还需要接收一个回调函数: <code>onPress</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;itemHeight, itemWidth, dic, onPress&#125; = <span class="variable language_">this</span>.<span class="property">props</span></span><br><span class="line">    </span><br><span class="line"> &lt;<span class="title class_">TouchableOpacity</span></span><br><span class="line">    style=&#123;&#123;<span class="attr">height</span>: itemHeight, <span class="attr">width</span>: itemWidth, <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>, <span class="attr">justifyContent</span>:<span class="string">&#x27;center&#x27;</span>,<span class="attr">backgroundColor</span>:<span class="string">&#x27;#EEEEEE&#x27;</span>&#125;&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        onPress &amp;&amp; <span class="title function_">onPress</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">            <span class="attr">isSelect</span>: <span class="literal">true</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>


<p>现在去 <code>items.push</code> 加入 <code>onPress</code> ，我们还需要一个状态 <code>selectItem</code> 来记录选中的标签:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 初始状态</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">    <span class="attr">itemHeight</span>: <span class="number">50</span>,</span><br><span class="line">    <span class="attr">selectItem</span>: <span class="literal">null</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Item</span></span><br><span class="line">    ref=&#123;index&#125;  <span class="comment">//设置 ref 以供获取自己</span></span><br><span class="line">    key=&#123;index&#125;</span><br><span class="line">    itemHeight=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">itemHeight</span>&#125;</span><br><span class="line">    itemWidth=&#123;itemWidth&#125;</span><br><span class="line">    dic=&#123;dic&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>() <span class="comment">//让已经选中的标签变为未选中</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]  <span class="comment">//获取到点击的标签</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>
<p>现在运行，就可以选中的时候取消上一个标签的选中状态了，但是我们需要默认选中第一个标签。</p>
<p>我们给 <code>Item</code> 加一个属性 <code>isSelect</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Item</span></span><br><span class="line">    ref=&#123;index&#125;  <span class="comment">//设置 ref 以供获取自己</span></span><br><span class="line">    key=&#123;index&#125;</span><br><span class="line">    isSelect=&#123;index == <span class="number">0</span>&#125;</span><br><span class="line">    itemHeight=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">itemHeight</span>&#125;</span><br><span class="line">    itemWidth=&#123;itemWidth&#125;</span><br><span class="line">    dic=&#123;dic&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>() <span class="comment">//让已经选中的标签变为未选中</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]  <span class="comment">//获取到点击的标签</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>修改 <code>Item</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">   <span class="variable language_">super</span>(props);</span><br><span class="line">   <span class="comment">// 初始状态</span></span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">       <span class="attr">isSelect</span>: props.<span class="property">isSelect</span></span><br><span class="line">   &#125;;</span><br><span class="line"> &#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure>

<p> 现在运行发现第一项已经默认选中，但是点击别的标签，发现第一项并没有变成未选中，这是因为 <code>this.state.selectItem</code> 初始值为 <code>null</code>，那我们需要把第一项标签赋值给它。</p>
<p>由于只有在视图加载或更新完成才能通过 <code>refs</code> 获取到某个视图，所以我们需要一个定时器去触发选中方法。</p>
<p>去 <code>Item</code> 的 <code>constructor()</code> 加入定时器:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">   <span class="variable language_">super</span>(props);</span><br><span class="line">   <span class="comment">// 初始状态</span></span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">       <span class="attr">isSelect</span>: props.<span class="property">isSelect</span></span><br><span class="line">   &#125;;</span><br><span class="line">   </span><br><span class="line">   <span class="variable language_">this</span>.<span class="property">timer</span> = <span class="built_in">setTimeout</span>(</span><br><span class="line">      <span class="function">() =&gt;</span> </span><br><span class="line">          props.<span class="property">isSelect</span> &amp;&amp; props.<span class="property">onPress</span> &amp;&amp; props.<span class="title function_">onPress</span>() <span class="comment">//100ms 后调用选中操作</span></span><br><span class="line">      ,</span><br><span class="line">      <span class="number">100</span></span><br><span class="line">    ); </span><br><span class="line">&#125;</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
<p>搞定，最后我们还需要点击靠后的标签可以自动居中，我们需要操作 <code>ScrollView</code> 的偏移量，给 <code>ScrollView</code> 设置 <code>ref=&#39;ScrollView&#39;</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;<span class="title class_">ScrollView</span></span><br><span class="line">    ref=<span class="string">&quot;ScrollView&quot;</span></span><br><span class="line">    style=&#123;styles.<span class="property">scrollView</span>&#125;</span><br><span class="line">    horizontal=&#123;<span class="literal">true</span>&#125;</span><br><span class="line">    showsHorizontalScrollIndicator=&#123;<span class="literal">false</span>&#125;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>


<p>然后去 <code>items.push</code> 加入偏移量的设置：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Item</span></span><br><span class="line">    ref=&#123;index&#125;</span><br><span class="line">    key=&#123;index&#125;</span><br><span class="line">    isSelect=&#123;index == <span class="number">0</span>&#125;</span><br><span class="line">    itemHeight=&#123;<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">itemHeight</span>&#125;</span><br><span class="line">    itemWidth=&#123;itemWidth&#125;</span><br><span class="line">    dic=&#123;dic&#125;</span><br><span class="line">    onPress=&#123;<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span>.<span class="title function_">_unSelect</span>()</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">selectItem</span> = <span class="variable language_">this</span>.<span class="property">refs</span>[index]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (list.<span class="property">length</span> &gt; maxItem) &#123;</span><br><span class="line">            <span class="keyword">let</span> meiosis = <span class="built_in">parseInt</span>(maxItem / <span class="number">2</span>)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">ScrollView</span>.<span class="title function_">scrollTo</span>(&#123;<span class="attr">x</span>: (index - meiosis &lt; <span class="number">0</span> ? <span class="number">0</span> : index - meiosis &gt; list.<span class="property">length</span> - maxItem ? list.<span class="property">length</span> - maxItem : index - meiosis ) * itemWidth, <span class="attr">y</span>: <span class="number">0</span>, <span class="attr">animated</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>


<p>现在的效果:</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative3/effect.gif?raw=true" alt="effect"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative3">项目地址</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/17/RN_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/17/RN_2/" class="post-title-link" itemprop="url">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-17 18:16:00" itemprop="dateCreated datePublished" datetime="2017-04-17T18:16:00+08:00">2017-04-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:17:54" itemprop="dateModified" datetime="2023-12-21T21:17:54+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative2">项目地址</a></p>
<h2 id="React-Native-App-的视图结构"><a href="#React-Native-App-的视图结构" class="headerlink" title="React Native App 的视图结构"></a>React Native App 的视图结构</h2><p>首先把 <code>setup.js</code> 的 <code>Root</code> 以及 布局 的代码改一下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">					</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">container</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>




<p><code>React Native</code> 的所有界面都是在一个主视图上，这里的这个 <code>&lt;View&gt;</code> 跟 <code>iOS</code> 中的 <code>Window</code> 是同样的，这里跟 <code>Android</code> 不太一样。</p>
<p>当然运行在 <code>iOS</code> 和 <code>Android</code> 中还是以 <code>ViewController</code> 和 <code>Activity</code> 展示的。</p>
<h2 id="StatusBar"><a href="#StatusBar" class="headerlink" title="StatusBar"></a>StatusBar</h2><p><code>iOS</code> 和 <code>Android</code> 的 <code>StatusBar</code> 是差不多的，都是顶部那高度 20 的部分，用来显示信号、电量等系统的信息。</p>
<p>在 <code>setup.js</code> 中加入 <code>StatusBar</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StatusBar</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">StatusBar</span> </span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">barStyle</span>=<span class="string">&#123;</span>&#x27;<span class="attr">light-content</span>&#x27;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">backgroundColor</span>=<span class="string">&#123;</span>&#x27;#<span class="attr">000000</span>&#x27;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>StatusBar</code> 的配置可以看<a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/statusbar.html#content">这里</a>，注意有些属性只针对特定平台。</p>
<p>这样可以设置整个 <code>App</code> 中 <code>StatusBar</code> 的样式，如果有某个页面 <code>A</code> 的 <code>StatusBar</code> 需要特殊处理，那么就在 <code>A</code> 页面加入 <code>StatusBar</code> 进行设置。</p>
<h2 id="Navigator"><a href="#Navigator" class="headerlink" title="Navigator"></a>Navigator</h2><p>我们需要用 <code>Navigator</code> 来让整个 <code>App</code> 可以在页面之间跳转。</p>
<p><code>Navigator</code> 和 <code>iOS</code> 的一样，都是对页面进行 <code>push</code> 和 <code>pop</code> ，跟 <code>Android</code> 的 <code>NavigationView</code> 不是一个东西。</p>
<p>官方文档在<a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/navigator.html#content">这里</a></p>
<p>现在在 <code>App</code> 文件夹内创建一个新的文件 <code>App.js</code> ：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">Text</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">		<span class="tag">&lt;<span class="name">Text</span>&gt;</span>main<span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span>,</span><br><span class="line">        <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span></span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>然后在 <code>setup</code> 内 <code>StatusBar</code> 下面加入 <code>Navigator</code> :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">App</span> <span class="keyword">from</span> <span class="string">&#x27;./App&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;<span class="title class_">Navigator</span></span><br><span class="line">    initialRoute=&#123;&#123; <span class="attr">component</span>: <span class="title class_">App</span> &#125;&#125;</span><br><span class="line"></span><br><span class="line">    style=&#123;&#123;<span class="attr">flex</span>:<span class="number">1</span>&#125;&#125;</span><br><span class="line">    renderScene=&#123;<span class="function">(<span class="params">route, navigator</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title class_">BackAndroid</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;hardwareBackPress&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">            <span class="keyword">if</span>(navigator == <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(navigator.<span class="title function_">getCurrentRoutes</span>().<span class="property">length</span> === <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            navigator.<span class="title function_">pop</span>();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> <span class="title class_">Component</span> = route.<span class="property">component</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Component</span> &#123;<span class="attr">...route.params</span>&#125; <span class="attr">navigator</span>=<span class="string">&#123;navigator&#125;/</span>&gt;</span></span></span><br><span class="line">        <span class="comment">//  上面的route.params 是为了方便后续界面间传递参数用的</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">/&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中 <code>initialRoute</code> 设置了 <code>component</code> ，是最底层的第一个页面。</p>
<p>然后 <code>renderScene</code> 控制 <code>push</code> 的时候做哪些操作，这里的 <code>BackAndroid.addEventListener</code> 是监听了 <code>Android</code> 的物理返回按键。</p>
<p>现在运行可以看见页面中间有个 <code>main</code> ：</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative2/main.png?raw=true"></p>
<p>你可能会发现为什么没 <code>NavigationBar</code> 呢，我们后面再加。</p>
<h2 id="tab-navigator"><a href="#tab-navigator" class="headerlink" title="tab-navigator"></a>tab-navigator</h2><p>官方并没有 <code>TabBar</code> ，我们使用一个第三方 <a target="_blank" rel="noopener" href="https://github.com/expo/react-native-tab-navigator">react-native-tab-navigator</a></p>
<p>在项目根目录执行命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install react-native-tab-navigator --save</span><br></pre></td></tr></table></figure>

<p>安装完成后在 <code>App.js</code> 加入 <code>TabNavigator</code>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">const home_key = &#x27;home&#x27;</span><br><span class="line">const satin_key = &#x27;satin&#x27;</span><br><span class="line">const setting_key = &#x27;setting&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import Home from &#x27;./Home/Home&#x27;</span><br><span class="line">import Satin from &#x27;./Satin/Satin&#x27;</span><br><span class="line">import Setting from &#x27;./Setting/Setting&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;TabNavigator&gt;</span><br><span class="line">	&lt;TabNavigator.Item</span><br><span class="line">	    selected=&#123;this.state.selectedTab === home_key&#125;</span><br><span class="line">	    title=&quot;首页&quot;</span><br><span class="line">	    titleStyle=&#123;styles.tabText&#125;</span><br><span class="line">	    selectedTitleStyle=&#123;styles.selectedTabText&#125;</span><br><span class="line">	    renderIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/home_unselect.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    renderSelectedIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/home_select.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    onPress=&#123;() =&gt; this.setState(&#123; selectedTab: home_key &#125;)&#125;&gt;</span><br><span class="line">	</span><br><span class="line">	    &lt;Home navigator=&#123;this.props.navigator&#125;/&gt;</span><br><span class="line">	&lt;/TabNavigator.Item&gt;</span><br><span class="line">	&lt;TabNavigator.Item</span><br><span class="line">	    selected=&#123;this.state.selectedTab === satin_key&#125;</span><br><span class="line">	    title=&quot;段子&quot;</span><br><span class="line">	    titleStyle=&#123;styles.tabText&#125;</span><br><span class="line">	    selectedTitleStyle=&#123;styles.selectedTabText&#125;</span><br><span class="line">	    renderIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/activity_unselect.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    renderSelectedIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/activity_select.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    onPress=&#123;() =&gt; this.setState(&#123; selectedTab: satin_key &#125;)&#125;&gt;</span><br><span class="line">	</span><br><span class="line">	    &lt;Satin navigator=&#123;this.props.navigator&#125;/&gt;</span><br><span class="line">	&lt;/TabNavigator.Item&gt;</span><br><span class="line">	&lt;TabNavigator.Item</span><br><span class="line">	    selected=&#123;this.state.selectedTab === setting_key&#125;</span><br><span class="line">	    title=&quot;我的&quot;</span><br><span class="line">	    titleStyle=&#123;styles.tabText&#125;</span><br><span class="line">	    selectedTitleStyle=&#123;styles.selectedTabText&#125;</span><br><span class="line">	    renderIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/my_unselect.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    renderSelectedIcon=&#123;() =&gt; &lt;Image style=&#123;styles.icon&#125; source=&#123;require(&quot;./Images/root/my_select.png&quot;)&#125; /&gt;&#125;</span><br><span class="line">	    onPress=&#123;() =&gt; this.setState(&#123; selectedTab: setting_key &#125;)&#125;&gt;</span><br><span class="line">	</span><br><span class="line">	    &lt;Setting navigator=&#123;this.props.navigator&#125;/&gt;</span><br><span class="line">	&lt;/TabNavigator.Item&gt;</span><br><span class="line">&lt;/TabNavigator&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>配置也比较易懂。</p>
<p>另外创建 3 个文件 <code>Home.js</code> 、 <code>Satin.js</code> 和 <code>Setting.js</code> </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Satin</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;orange&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以给每个设置不同的颜色，这样点击界面切换也很明显。</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative2/tab.png?raw=true"></p>
<p>具体的代码可以看 <a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative2">项目</a></p>
<h2 id="NavigationBar"><a href="#NavigationBar" class="headerlink" title="NavigationBar"></a>NavigationBar</h2><p>同意官方也没有提供 <code>NavigationBar</code>，我们需要自定义一个。</p>
<p>然后在 <code>Home.js</code> 、  <code>Satin.js</code> 和 <code>Setting.js</code> 加入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">View</span>,</span><br><span class="line">    <span class="title class_">StyleSheet</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">NavigationBar</span> <span class="keyword">from</span> <span class="string">&#x27;../Custom/NavBarCommon&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Home</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.view&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">NavigationBar</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">title</span>=<span class="string">&quot;首页&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                    <span class="attr">unLeftImage</span>=<span class="string">&#123;true&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">                /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">view</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>:<span class="number">1</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;white&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative2/navibar.png?raw=true" alt="navibar"></p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative2">项目地址</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/04/14/RN_1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/04/14/RN_1/" class="post-title-link" itemprop="url">React Native (一)：基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-04-14 17:05:00" itemprop="dateCreated datePublished" datetime="2017-04-14T17:05:00+08:00">2017-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-12-21 21:17:20" itemprop="dateModified" datetime="2023-12-21T21:17:20+08:00">2023-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a href="/2017/04/14/RN_1/">React Native (一)：基础</a></p>
<p><a href="/2017/04/17/RN_2/">React Native (二)：StatusBar 、 NavigationBar 与 TabBar</a></p>
<p><a href="/2017/04/18/RN_3/">React Native (三)：自定义视图</a></p>
<p><a href="/2017/04/24/RN_4/">React Native (四)：加载新闻列表</a></p>
<p><a href="/2017/05/03/RN_5/">React Native (五)：上下拉刷新加载</a></p>
<p><a href="/2017/05/05/RN_6/">React Native (六)：加载所有分类与详情页</a></p>
<p>最近刚完成一个 <code>React Native</code> 的项目，踩了无数坑，去年折腾过几周，后来因为有两个 <code>iOS</code> 项目就没有再折腾，当时想要写一个主文件，分别给 <code>Android</code> 和 <code>iOS</code> 引用，但是弄了好久也不会弄，也下载了 <a target="_blank" rel="noopener" href="https://github.com/fbsamples/f8app"><code>f8app</code></a> 看了，不过完全看不懂，就这样放弃了。</p>
<p>今年 3 月中旬正好公司有个项目只需要前端，而且公司没有 <code>Android</code> 开发，也想弄混合开发，于是正好我拿这个项目去练手。</p>
<p>从上面的描述也看出来我是一个 <code>iOS</code> 开发，对于有移动开发基础的人来说做 <code>React Native</code> 开发还是比较好上手的，前端的话更容易，只是刚开始入门比较费劲，也找不到个能问的人。总的下来我的建议还是如果卡在某个地方很久很烦躁不想继续学了，那么放一放，放几天或者一两周，再继续学，不要轻易放弃，入门后就轻松多了。</p>
<h2 id="1-说明"><a href="#1-说明" class="headerlink" title="1.说明"></a>1.说明</h2><p>这系列文章主要还是针对有编程经验的开发者，起码掌握一门主流的编程语言。</p>
<p>开发平台： Mac OS</p>
<p>IDE: WebStorm</p>
<p>这里我并不会很详细的一步一步的讲解，详细的教程可以看<a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/getting-started.html">官方教程</a>，这里主要是记录一些我在学习过程中遇到的疑难杂症，如果你碰到了或许可以帮你一把。</p>
<h2 id="2-基础"><a href="#2-基础" class="headerlink" title="2.基础"></a>2.基础</h2><p>首先既然看这个文章，那么默认你已经知道什么是 <a target="_blank" rel="noopener" href="http://reactnative.cn/">React Native</a> 以及是干什么的，还有你需要会一些 <code>JavaScript</code> ，如果你还不会 <code>JavaScript </code>，那么推荐 <code>廖雪峰老师</code> 的 <a target="_blank" rel="noopener" href="http://www.liaoxuefeng.com/wiki/001434446689867b27157e896e74d51a89c25cc8b43bdb3000">JavaScript教程</a> 和 <code>阮一峰老师</code> 的 <a target="_blank" rel="noopener" href="http://es6.ruanyifeng.com/#README">ECMAScript 6 入门</a>。</p>
<p>官方文档永远是必看的，对于初学者来说不会的先去官方文档找。<a target="_blank" rel="noopener" href="http://reactnative.cn/">React Native中文网</a> 对于英文不好的同学来说是首选，比如我自己。</p>
<p>有问题也可以去 <code>React Native</code> 的 <a target="_blank" rel="noopener" href="https://github.com/facebook/react-native">GitHub地址</a> 的 <code>issues</code> 找。</p>
<h2 id="3-搭建开发环境"><a href="#3-搭建开发环境" class="headerlink" title="3.搭建开发环境"></a>3.搭建开发环境</h2><p>这部分比较简单，按着 <a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/getting-started.html">官方教程</a> 搭建即可，但是在运行命令的时候可能会出各种问题，这个时候只能靠 <code>Baidu</code> 和 <code>Google</code> 了，我是一次成功的，所以也不知道会有什么问题，这里也不做过多说明了。</p>
<p>希望没人在这一步就放弃了。</p>
<h2 id="4-iOS-和-Android-调用统一资源"><a href="#4-iOS-和-Android-调用统一资源" class="headerlink" title="4.iOS 和 Android 调用统一资源"></a>4.iOS 和 Android 调用统一资源</h2><p>新创建的项目 <code>iOS</code> 和 <code>Android</code> 代码是分开的，分别在 <code>index.ios.js</code> 和 <code>index.android.js</code> 中，这是两个平台的入口。</p>
<p>顶部的各种 <code>import</code> 是引入的各种资源：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">AppRegistry</span>,</span><br><span class="line">  <span class="title class_">StyleSheet</span>,</span><br><span class="line">  <span class="title class_">Text</span>,</span><br><span class="line">  <span class="title class_">View</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>接下来是 <code>React</code> 的语法，创建了一些视图:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ReactNative1</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.welcome&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          Welcome to React Native!</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          To get started, edit index.ios.js</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">          Press Cmd+R to reload,&#123;&#x27;\n&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">          Cmd+D or shake for dev menu</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是布局的代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">  <span class="attr">container</span>: &#123;</span><br><span class="line">    <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">backgroundColor</span>: <span class="string">&#x27;#F5FCFF&#x27;</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">welcome</span>: &#123;</span><br><span class="line">    <span class="attr">fontSize</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">margin</span>: <span class="number">10</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">instructions</span>: &#123;</span><br><span class="line">    <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">    <span class="attr">color</span>: <span class="string">&#x27;#333333&#x27;</span>,</span><br><span class="line">    <span class="attr">marginBottom</span>: <span class="number">5</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>最后是注册，每个平台只需要注册一次：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">AppRegistry</span>.<span class="title function_">registerComponent</span>(<span class="string">&#x27;ReactNative1&#x27;</span>, <span class="function">() =&gt;</span> <span class="title class_">ReactNative1</span>);</span><br></pre></td></tr></table></figure>

<p>上面的那一大堆不用去管，我们就从这个方法入手，这个方法传入了 2 个参数，第一个是 <code>App</code> 的标志，这个你们应该也明白不能随便改，第二个参数是一个匿名方法，调用这个方法会返回 <code>ReactNative1</code> ，就是上面的 <code>React</code> 创建的类，那么要让 <code>iOS</code> 和 <code>Android</code> 引用同一个资源，只需要这里返回给同一个类即可。</p>
<p>新创建一个文件夹 <code>App</code> 或者随便啥，我们写的所有 <code>JS</code> 文件都放这里，方便管理。</p>
<p>然后在 <code>App</code> 内创建一个 <code>setup.js</code>，这时候目录看起来是这样子:</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/directory.jpeg?raw=true" alt="目录"></p>
<p>然后在把 <code>index.ios.js</code> 的 <code>import</code> 、 <code>React</code> 和 <code>布局</code> 部分的内容复制过来，然后加入两句代码，现在 <code>setup.js</code> 文件是这样的：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">StyleSheet</span>,</span><br><span class="line">    <span class="title class_">Text</span>,</span><br><span class="line">    <span class="title class_">View</span></span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">setup</span>(<span class="params"></span>): <span class="title class_">ReactClass</span>&lt;&#123;&#125;&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里做一些注册第三方等App初始化需要的操作</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Root</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> <span class="keyword">extends</span> <span class="title class_ inherited__">React.Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">View</span> <span class="attr">style</span>=<span class="string">&#123;styles.container&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.welcome&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    Welcome to React Native!</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    To get started, edit index.android.js</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Text</span> <span class="attr">style</span>=<span class="string">&#123;styles.instructions&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    Double tap R on your keyboard to reload,&#123;&#x27;\n&#x27;&#125;</span></span><br><span class="line"><span class="language-xml">                    Shake or press menu button for dev menu</span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Text</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">View</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = <span class="title class_">StyleSheet</span>.<span class="title function_">create</span>(&#123;</span><br><span class="line">    <span class="attr">container</span>: &#123;</span><br><span class="line">        <span class="attr">flex</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">justifyContent</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">alignItems</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">backgroundColor</span>: <span class="string">&#x27;#F5FCFF&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">welcome</span>: &#123;</span><br><span class="line">        <span class="attr">fontSize</span>: <span class="number">20</span>,</span><br><span class="line">        <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">margin</span>: <span class="number">10</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">instructions</span>: &#123;</span><br><span class="line">        <span class="attr">textAlign</span>: <span class="string">&#x27;center&#x27;</span>,</span><br><span class="line">        <span class="attr">color</span>: <span class="string">&#x27;#333333&#x27;</span>,</span><br><span class="line">        <span class="attr">marginBottom</span>: <span class="number">5</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = setup</span><br></pre></td></tr></table></figure>

<p>我这里是直接导入了 <code>import React from &#39;react&#39;</code> ，那么在创建 <code>React类</code> 的时候就需要 <code>extends React.Component</code> ，我是习惯这种写法，如果你觉得官方的写法比较好，那么就按着官方的写就行。</p>
<p>然后修改 <code>index.ios.js</code> 和 <code>index.android.js</code> ,修改成一模一样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">    <span class="title class_">AppRegistry</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> setup <span class="keyword">from</span> <span class="string">&#x27;./App/setup&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title class_">AppRegistry</span>.<span class="title function_">registerComponent</span>(<span class="string">&#x27;ReactNative1&#x27;</span>, setup);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果已经在运行，那么 <code>iOS模拟器</code> 按 <code>command + R</code> 刷新，<code>Android模拟器</code> 双击 <code>R</code> 刷新。</p>
<p>如果没有在运行那么运行 <code>react-native run-ios</code> 和 <code>react-native run-android</code> 查看效果。</p>
<p>如果运行的时候遇见这个错误：</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/firstError.png?raw=true" alt="firstError"></p>
<p>那么需要关闭 <code>react-native</code> 启动的服务，重新启动。</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/iterm.jpeg?raw=true" alt="iterm"></p>
<p>如果一切正常，那么尝试修改 <code>setup.js</code> 中 <code>Text</code> 标签中的文字，刷新 <code>iOS</code> 和 <code>Android</code> 看看效果。</p>
<p><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/ios.png?raw=true"><img src="https://github.com/qiangxinyu/ReactNativeExample/blob/master/ReactNative1/android.png?raw=true"></p>
<p>如果你坚持到了这里，那么恭喜你已经初步掌握了 <code>react native</code> 。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/qiangxinyu/ReactNativeExample/tree/master/ReactNative1">示例项目地址</a></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://github.com/fbsamples/f8app">f8app</a></p>
<p><a target="_blank" rel="noopener" href="http://reactnative.cn/docs/0.43/getting-started.html">React Native中文网</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/facebook/react-native/issues/6613">https://github.com/facebook/react-native/issues/6613</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/01/21/AndroidAddBaiduMap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="qxy">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一艘小船">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/01/21/AndroidAddBaiduMap/" class="post-title-link" itemprop="url">Android 添加百度地图的问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-01-21 12:03:00" itemprop="dateCreated datePublished" datetime="2017-01-21T12:03:00+08:00">2017-01-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2017-04-13 18:45:00" itemprop="dateModified" datetime="2017-04-13T18:45:00+08:00">2017-04-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>好久没写东西了，一直在忙着学 <code>React native</code>。</p>
<p>今天给 <code>Android</code> 导入<code>百度地图</code> 的时候遇见定位监听不回调的问题，记录一下。</p>
<p>电脑系统：Mac OS 10.12.4</p>
<p>IDE： Android Studio 2.1.2</p>
<p>JRE: 1.8.0_121-b13 x86_64</p>
<p>手机：Mi-4c   </p>
<p>Android Version:  5.1.1LMY47V</p>
<h4 id="1-确定-百度key-设置正确"><a href="#1-确定-百度key-设置正确" class="headerlink" title="1.确定 百度key 设置正确"></a>1.确定 <code>百度key</code> 设置正确</h4><p><code>meta-data </code> 要放在 <code>application</code> 里面。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;application&gt;  </span><br><span class="line">    &lt;meta-data  </span><br><span class="line">        android:name=&quot;com.baidu.lbsapi.API_KEY&quot;  </span><br><span class="line">        android:value=&quot;开发者 key&quot; /&gt;  </span><br><span class="line">&lt;/application&gt;</span><br></pre></td></tr></table></figure>


<h4 id="2-确定权限都添加"><a href="#2-确定权限都添加" class="headerlink" title="2.确定权限都添加"></a>2.确定权限都添加</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot;/&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.SYSTEM_ALERT_WINDOW&quot;/&gt;</span><br><span class="line">&lt;!-- 这个权限用于进行网络定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 这个权限用于访问GPS定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 用于访问wifi网络信息，wifi信息会用于进行网络定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_WIFI_STATE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 获取运营商信息，用于支持提供运营商信息相关的接口--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 这个权限用于获取wifi的获取权限，wifi信息会用来进行网络定位--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.CHANGE_WIFI_STATE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 用于读取手机当前的状态--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.READ_PHONE_STATE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 写入扩展存储，向扩展卡写入数据，用于写入离线定位数据--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.WRITE_EXTERNAL_STORAGE&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line">&lt;!-- 访问网络，网络定位需要上网--&gt;</span><br><span class="line">&lt;!-- SD卡读取权限，用户写入离线定位数据--&gt;</span><br><span class="line">&lt;uses-permission android:name=&quot;android.permission.MOUNT_UNMOUNT_FILESYSTEMS&quot;&gt;&lt;/uses-permission&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="3-需要设置-service"><a href="#3-需要设置-service" class="headerlink" title="3. 需要设置 service"></a>3. 需要设置 <code>service</code></h4><p> 也放在 <code>application</code> 里面，后面的版本号与导入的 <code>百度SDK</code> 版本号一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;service android:name=&quot;com.baidu.location.f&quot; android:enabled=&quot;true&quot; android:process=&quot;:remote&quot;&gt;</span><br><span class="line">	  &lt;intent-filter&gt;</span><br><span class="line">	       &lt;action android:name=&quot;com.baidu.location.service_v4.3&quot; &gt;</span><br><span class="line">	        &lt;/action&gt;</span><br><span class="line">	  &lt;/intent-filter&gt;</span><br><span class="line">&lt;/service&gt;</span><br><span class="line">	       </span><br></pre></td></tr></table></figure>


<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="http://lbsyun.baidu.com/index.php?title=androidsdk">百度官方文档</a></p>
<p><a target="_blank" rel="noopener" href="http://bbs.lbsyun.baidu.com/forum.php?mod=viewthread&tid=10847">http://bbs.lbsyun.baidu.com/forum.php?mod=viewthread&tid=10847</a></p>
<p><a target="_blank" rel="noopener" href="http://bbs.csdn.net/topics/390803526">http://bbs.csdn.net/topics/390803526</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">qxy</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">27</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">qxy</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
